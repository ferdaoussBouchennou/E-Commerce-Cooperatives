@model List<E_Commerce_Cooperatives.Models.Commande>
@{
    ViewBag.Title = "Gestion des Commandes";
    Layout = "~/Views/Admin/_AdminLayout.cshtml";
    
    var stats = ViewBag.Stats as Dictionary<string, int> ?? new Dictionary<string, int>();
    var searchTerm = ViewBag.SearchTerm as string ?? "";
    var statutFilter = ViewBag.StatutFilter as string ?? "all";
    var dateFrom = ViewBag.DateFrom as DateTime?;
    var dateTo = ViewBag.DateTo as DateTime?;
    var montantMin = ViewBag.MontantMin as decimal?;
    var montantMax = ViewBag.MontantMax as decimal?;
}

<div class="admin-page">
    <div class="admin-page-header">
        <h1 class="admin-page-title">Gestion des Commandes</h1>
        <p class="admin-page-subtitle">Suivez et gérez les commandes clients</p>
    </div>

    <!-- Search and Filters -->
    <div class="admin-filters">
        <form method="get" action="@Url.Action("Commandes", "Admin")" class="filter-form">
            <div class="filters-row">
                <div class="search-box">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="search-icon">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                    </svg>
                    <input type="text" name="searchTerm" class="form-control search-input" placeholder="Rechercher..." value="@searchTerm" />
                </div>
                <div class="status-filter-wrapper">
                    <select name="statutFilter" class="status-filter">
                        <option value="all" @(statutFilter == "all" ? "selected" : "")>Tous les statuts</option>
                        <option value="Validée" @(statutFilter == "Validée" ? "selected" : "")>Validée</option>
                        <option value="Préparation" @(statutFilter == "Préparation" ? "selected" : "")>Préparation</option>
                        <option value="Expédiée" @(statutFilter == "Expédiée" ? "selected" : "")>Expédiées</option>
                        <option value="Livrée" @(statutFilter == "Livrée" ? "selected" : "")>Livrées</option>
                        <option value="Annulée" @(statutFilter == "Annulée" ? "selected" : "")>Annulées</option>
                    </select>
                </div>
                <div class="date-filter-item">
                    <input type="date" name="dateFrom" id="dateFrom" class="form-control date-filter" placeholder="Date début" value="@(dateFrom.HasValue ? dateFrom.Value.ToString("yyyy-MM-dd") : "")" title="Date de début" />
                </div>
                <div class="date-filter-item">
                    <input type="date" name="dateTo" id="dateTo" class="form-control date-filter" placeholder="Date fin" value="@(dateTo.HasValue ? dateTo.Value.ToString("yyyy-MM-dd") : "")" title="Date de fin" />
                </div>
                <div class="amount-filter-item">
                    <input type="number" name="montantMin" id="montantMin" class="form-control amount-filter" step="0.01" min="0" placeholder="Montant min" value="@(montantMin.HasValue ? montantMin.Value.ToString("0.00") : "")" title="Montant minimum (MAD)" />
                </div>
                <div class="amount-filter-item">
                    <input type="number" name="montantMax" id="montantMax" class="form-control amount-filter" step="0.01" min="0" placeholder="Montant max" value="@(montantMax.HasValue ? montantMax.Value.ToString("0.00") : "")" title="Montant maximum (MAD)" />
                </div>
                <div class="filter-actions">
                    <button type="submit" class="btn-filter-apply">Appliquer</button>
                    <a href="@Url.Action("Commandes", "Admin")" class="btn-filter-reset">Réinitialiser</a>
                </div>
            </div>
        </form>
    </div>

    <!-- Stats Cards -->
    <div class="stats-cards">
        <div class="stat-card stat-total">
            <div class="stat-value">@(stats.ContainsKey("Total") ? stats["Total"] : 0)</div>
            <div class="stat-label">Total</div>
        </div>
        <div class="stat-card stat-pending">
            <div class="stat-value">@(stats.ContainsKey("Validée") ? stats["Validée"] : 0)</div>
            <div class="stat-label">Validée</div>
        </div>
        <div class="stat-card stat-preparation">
            <div class="stat-value">@(stats.ContainsKey("Préparation") ? stats["Préparation"] : 0)</div>
            <div class="stat-label">Préparation</div>
        </div>
        <div class="stat-card stat-shipped">
            <div class="stat-value">@(stats.ContainsKey("Expédiée") ? stats["Expédiée"] : 0)</div>
            <div class="stat-label">Expédiées</div>
        </div>
        <div class="stat-card stat-delivered">
            <div class="stat-value">@(stats.ContainsKey("Livrée") ? stats["Livrée"] : 0)</div>
            <div class="stat-label">Livrées</div>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="admin-table-container">
        <table class="table admin-table">
            <thead>
                <tr>
                    <th>N° Commande</th>
                    <th>Client</th>
                    <th>Date</th>
                    <th>Montant</th>
                    <th>Livraison</th>
                    <th>Statut</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody id="ordersTableBody">
                @foreach (var commande in Model)
                {
                    <tr class="order-row" data-commande-id="@commande.CommandeId">
                        <td class="order-number">@commande.NumeroCommande</td>
                        <td>
                            <div class="client-info">
                                @if (commande.Client != null)
                                {
                                    <a href="#" class="client-name">@(commande.Client.Prenom ?? "") @(commande.Client.Nom ?? "")</a>
                                    <div class="client-email">@(commande.Client.Email ?? "N/A")</div>
                                }
                                else
                                {
                                    <span class="text-muted">Client non disponible</span>
                                }
                            </div>
                        </td>
                        <td>@commande.DateCommande.ToString("yyyy-MM-dd")</td>
                        <td class="order-amount">@commande.TotalTTC.ToString("0.00") MAD</td>
                        <td>
                            <span class="badge badge-delivery badge-@(commande.ModeLivraison?.Nom?.ToLower().Replace(" ", "-") ?? "standard")">
                                @(commande.ModeLivraison?.Nom ?? "Standard")
                            </span>
                        </td>
                        <td>
                            @{
                                var statutDisplay = commande.Statut ?? "Non défini";
                                var statutClass = !string.IsNullOrEmpty(commande.Statut) 
                                    ? commande.Statut.ToLower().Replace(" ", "-").Replace("é", "e").Replace("è", "e") 
                                    : "non-defini";
                            }
                            <span class="badge badge-status badge-@statutClass">
                                @if (commande.Statut == "Validée")
                                {
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16" class="badge-icon">
                                        <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                    </svg>
                                }
                                else if (commande.Statut == "Préparation")
                                {
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16" class="badge-icon">
                                        <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5 8 5.961 14.154 3.5 8.186 1.113zM15 4.239l-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z"/>
                                    </svg>
                                }
                                else if (commande.Statut == "Expédiée")
                                {
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 24 24" class="badge-icon">
                                        <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
                                    </svg>
                                }
                                else if (commande.Statut == "Livrée")
                                {
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16" class="badge-icon">
                                        <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                    </svg>
                                }
                                else if (commande.Statut == "Annulée")
                                {
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16" class="badge-icon">
                                        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
                                    </svg>
                                }
                                @statutDisplay
                            </span>
                        </td>
                        <td class="text-end">
                            <button class="btn-action" onclick="showOrderDetails(@commande.CommandeId)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                                    <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                                </svg>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <div id="ordersPagination" class="orders-pagination" style="display: none;">
            <!-- Pagination controls will be inserted here -->
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" role="dialog" aria-labelledby="orderDetailsModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailsModalLabel">Détails de la commande <span id="modalOrderNumber"></span></h5>
                <button type="button" class="close" onclick="closeOrderModal()" aria-label="Close" style="border: none; background: none; font-size: 1.5rem; cursor: pointer; color: #666; padding: 0; margin-left: auto; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                    <span aria-hidden="true" style="font-size: 1.5rem; line-height: 1;">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="orderDetailsContent">
                <div style="text-align: center; padding: 20px;">
                    <p>Chargement des détails...</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        // Pagination des commandes - 4 commandes par page
        var ordersPerPage = 4;
        var ordersCurrentPage = 1;
        var ordersTotalPages = 1;
        
        // Initialize pagination when document is ready
        if (typeof jQuery !== 'undefined') {
            $(document).ready(function() {
                initializeOrdersPagination();
            });
        } else {
            // Fallback if jQuery is not loaded yet
            window.addEventListener('DOMContentLoaded', function() {
                if (typeof jQuery !== 'undefined') {
                    initializeOrdersPagination();
                } else {
                    // Retry after a short delay
                    setTimeout(function() {
                        if (typeof jQuery !== 'undefined') {
                            initializeOrdersPagination();
                        }
                    }, 100);
                }
            });
        }
        
        function initializeOrdersPagination() {
            var allRows = $('.order-row');
            var totalOrders = allRows.length;
            ordersTotalPages = Math.ceil(totalOrders / ordersPerPage);
            
            if (ordersTotalPages > 1) {
                $('#ordersPagination').show();
                createOrdersPagination();
            } else {
                $('#ordersPagination').hide();
            }
            
            renderOrdersPage(1);
        }
        
        function renderOrdersPage(page) {
            var allRows = $('.order-row');
            var start = (page - 1) * ordersPerPage;
            var end = start + ordersPerPage;
            
            allRows.hide();
            allRows.slice(start, end).show();
            
            ordersCurrentPage = page;
            updateOrdersPaginationControls();
        }
        
        function createOrdersPagination() {
            var html = '<div class="orders-pagination-controls">' +
                '<button class="btn-pagination btn-pagination-prev" onclick="changeOrdersPage(-1)" disabled>' +
                '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">' +
                '<path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>' +
                '</svg> Précédent</button>' +
                '<div class="pagination-pages">';
            
            for (var i = 1; i <= ordersTotalPages; i++) {
                html += '<button class="btn-page-number' + (i === 1 ? ' active' : '') + '" onclick="goToOrdersPage(' + i + ')">' + i + '</button>';
            }
            
            html += '</div>' +
                '<button class="btn-pagination btn-pagination-next" onclick="changeOrdersPage(1)">' +
                'Suivant <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">' +
                '<path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>' +
                '</svg></button>' +
                '</div>';
            
            $('#ordersPagination').html(html);
        }
        
        function changeOrdersPage(direction) {
            var newPage = ordersCurrentPage + direction;
            if (newPage >= 1 && newPage <= ordersTotalPages) {
                renderOrdersPage(newPage);
            }
        }
        
        function goToOrdersPage(page) {
            if (page >= 1 && page <= ordersTotalPages) {
                renderOrdersPage(page);
            }
        }
        
        function updateOrdersPaginationControls() {
            $('.orders-pagination-controls .btn-pagination-prev').prop('disabled', ordersCurrentPage === 1);
            $('.orders-pagination-controls .btn-pagination-next').prop('disabled', ordersCurrentPage === ordersTotalPages);
            
            $('.orders-pagination-controls .btn-page-number').removeClass('active');
            $('.orders-pagination-controls .btn-page-number').eq(ordersCurrentPage - 1).addClass('active');
        }
        
        function showOrderDetails(commandeId) {
            console.log('Chargement des détails de la commande:', commandeId);
            
            // Vérifier que jQuery est disponible
            if (typeof jQuery === 'undefined' || typeof $ === 'undefined') {
                alert('Erreur : jQuery n\'est pas chargé. Veuillez rafraîchir la page.');
                console.error('jQuery n\'est pas disponible');
                return;
            }
            
            if (!commandeId || commandeId <= 0) {
                alert('Erreur : ID de commande invalide');
                return;
            }
            
            var url = '@Url.Action("Details", "Admin")';
            console.log('URL:', url);
            
            // Afficher un message de chargement
            $('#orderDetailsContent').html('<div style="text-align: center; padding: 40px;"><p>Chargement des détails...</p></div>');
            
            $.get(url, { id: commandeId })
                .done(function (data) {
                    console.log('Données reçues:', data);
                    if (!data) {
                        alert('Erreur : Impossible de charger les détails de la commande');
                        return;
                    }
                
                var order = data;
                $('#modalOrderNumber').text(order.NumeroCommande || 'N/A');
                
                // Map status for display (using actual database statuses)
                var statusMap = {
                    "Validée": "Validée",
                    "Préparation": "Préparation",
                    "Expédiée": "Expédiée",
                    "Livrée": "Livrée",
                    "Annulée": "Annulée"
                };
                
                // Pagination settings - 4 produits par page
                var itemsPerPage = 4;
                var items = order.Items || [];
                var totalItems = items.length;
                var totalPages = Math.ceil(totalItems / itemsPerPage);
                
                // Store items data for pagination
                window.orderItemsData = items;
                window.orderItemsCurrentPage = 1;
                window.orderItemsPerPage = itemsPerPage;
                window.orderItemsTotalPages = totalPages;
                
                // Client info
                var clientName = 'Client non disponible';
                var clientEmail = 'N/A';
                if (order.Client) {
                    var prenom = order.Client.Prenom || '';
                    var nom = order.Client.Nom || '';
                    clientName = (prenom + ' ' + nom).trim() || 'Client non disponible';
                    clientEmail = order.Client.Email || 'N/A';
                }
                
                var html = '<div class="order-details">' +
                    '<div class="row mb-4">' +
                    '<div class="col-md-6 mb-3 mb-md-0">' +
                    '<div class="detail-card">' +
                    '<h6 class="detail-title">Client</h6>' +
                    '<p class="mb-1">' + clientName + '</p>' +
                    '<p class="text-muted small">' + clientEmail + '</p>' +
                    '</div>' +
                    '</div>' +
                    '<div class="col-md-6">' +
                    '<div class="detail-card">' +
                    '<h6 class="detail-title">Livraison</h6>' +
                    '<p class="mb-1">' + (order.ModeLivraison && order.ModeLivraison.Nom ? order.ModeLivraison.Nom : 'Standard') + '</p>' +
                    (order.Adresse && order.Adresse.AdresseComplete 
                        ? '<p class="text-muted small">' + order.Adresse.AdresseComplete + ', ' + (order.Adresse.Ville || '') + '</p>' 
                        : '<p class="text-muted small">Adresse non disponible</p>') +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '<div class="order-items">' +
                    '<div class="d-flex justify-content-between align-items-center mb-3">' +
                    '<h6 class="detail-title mb-0">Produits commandés <span class="items-count">(' + totalItems + ')</span></h6>' +
                    (totalPages > 1 ? '<div class="items-pagination-info">Page <span id="currentPage">1</span> sur ' + totalPages + '</div>' : '') +
                    '</div>' +
                    '<div id="orderItemsContainer">' +
                    '<table class="order-items-table">' +
                    '<tbody id="orderItemsBody">';
                
                // Render first page items
                var start = 0;
                var end = Math.min(itemsPerPage, totalItems);
                for (var i = start; i < end; i++) {
                    var item = items[i];
                    if (item && item.Produit) {
                        html += '<tr class="order-item-row">' +
                            '<td style="width: 70%;">' +
                            '<div class="order-item-name">' + (item.Produit.Nom || 'Produit inconnu') + '</div>' +
                            '<div class="order-item-quantity">Quantité: ' + (item.Quantite || 0) + '</div>' +
                            '</td>' +
                            '<td style="width: 30%;" class="order-item-price">' +
                            '<strong>' + (item.TotalLigne || 0).toFixed(2) + ' MAD</strong>' +
                            '</td>' +
                            '</tr>';
                    }
                }
                
                html += '</tbody></table>' +
                    '</div>';
                
                // Add pagination controls if more than one page
                if (totalPages > 1) {
                    html += '<div class="order-items-pagination">' +
                        '<button class="btn-pagination btn-pagination-prev" onclick="changeOrderItemsPage(-1)" disabled>' +
                        '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">' +
                        '<path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>' +
                        '</svg> Précédent</button>' +
                        '<div class="pagination-pages">';
                    
                    for (var i = 1; i <= totalPages; i++) {
                        html += '<button class="btn-page-number' + (i === 1 ? ' active' : '') + '" onclick="goToOrderItemsPage(' + i + ')">' + i + '</button>';
                    }
                    
                    html += '</div>' +
                        '<button class="btn-pagination btn-pagination-next" onclick="changeOrderItemsPage(1)">' +
                        'Suivant <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">' +
                        '<path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>' +
                        '</svg></button>' +
                        '</div>';
                }
                
                html += '<div class="order-total-section">' +
                    '<span class="order-total-label">Total</span>' +
                    '<span class="order-total-amount">' + (order.TotalTTC || 0).toFixed(2) + ' MAD</span>' +
                    '</div>' +
                    '</div>' +
                    '<div class="order-status-update">' +
                    '<label class="form-label">Modifier le statut</label>' +
                    '<div class="order-status-input-group">' +
                    '<select class="form-select" id="newStatus">' +
                    '<option value="Validée"' + (order.Statut === "Validée" ? " selected" : "") + '>Validée</option>' +
                    '<option value="Préparation"' + (order.Statut === "Préparation" ? " selected" : "") + '>Préparation</option>' +
                    '<option value="Expédiée"' + (order.Statut === "Expédiée" ? " selected" : "") + '>Expédiée</option>' +
                    '<option value="Livrée"' + (order.Statut === "Livrée" ? " selected" : "") + '>Livrée</option>' +
                    '</select>' +
                    '<button class="btn-update-status" onclick="updateOrderStatus(' + (order.CommandeId || 0) + ')">Mettre à jour</button>' +
                    '</div>';
                
                // Section d'actions (annulation + impression) - alignées horizontalement
                html += '<div class="order-actions-section">';
                
                // Bouton d'annulation - visible seulement si la commande n'est pas déjà annulée
                if (order.Statut !== "Annulée" && order.Statut) {
                    html += '<button type="button" class="btn-cancel-order" onclick="showCancelForm(' + order.CommandeId + ')">' +
                        '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 6px;">' +
                        '<path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>' +
                        '</svg>Annuler la commande</button>';
                }
                
                html += '<a href="@Url.Action("PrintInvoice", "Admin")?id=' + (order.CommandeId || 0) + '" class="btn-print" target="_blank">Imprimer facture</a>' +
                    '<a href="@Url.Action("PrintDeliverySlip", "Admin")?id=' + (order.CommandeId || 0) + '" class="btn-print" target="_blank">Bordereau de livraison</a>' +
                    '</div>';
                
                // Formulaire d'annulation (affiché séparément en dessous)
                if (order.Statut !== "Annulée" && order.Statut) {
                    html += '<div id="cancelForm_' + (order.CommandeId || 0) + '" class="cancel-form" style="display: none; margin-top: 12px;">' +
                        '<label class="form-label">Raison d\'annulation <span style="color: #dc3545;">*</span></label>' +
                        '<textarea id="raisonAnnulation_' + (order.CommandeId || 0) + '" class="form-control cancel-reason-input" rows="3" placeholder="Veuillez indiquer la raison de l\'annulation..." required></textarea>' +
                        '<div class="cancel-form-actions" style="margin-top: 10px;">' +
                        '<button type="button" class="btn-confirm-cancel" onclick="cancelOrder(' + (order.CommandeId || 0) + ')">Confirmer l\'annulation</button>' +
                        '<button type="button" class="btn-cancel-cancel" onclick="hideCancelForm(' + (order.CommandeId || 0) + ')">Annuler</button>' +
                        '</div>' +
                        '</div>';
                }
                
                html += '</div>';
                
                $('#orderDetailsContent').html(html);
                
                // Ouvrir la modal avec jQuery/Bootstrap
                var $modal = $('#orderDetailsModal');
                
                if ($modal.length === 0) {
                    alert('Erreur : La modal n\'a pas été trouvée dans le DOM');
                    console.error('Modal #orderDetailsModal non trouvée');
                    return;
                }
                
                // Nettoyer d'abord toute instance existante
                $modal.removeClass('show');
                $('.modal-backdrop').remove();
                $('body').removeClass('modal-open');
                $('body').css({overflow: '', paddingRight: ''});
                
                // Attendre un peu pour s'assurer que le nettoyage est terminé
                setTimeout(function() {
                    try {
                        // Initialiser la modal avec Bootstrap (jQuery)
                        $modal.modal({
                            backdrop: 'static',
                            keyboard: false,
                            show: true
                        });
                        
                        // S'assurer que la modal est visible
                        $modal.addClass('show');
                        $modal.css({
                            'display': 'block',
                            'padding-right': '0px'
                        });
                        
                        // Empêcher la fermeture au clic sur le backdrop
                        $modal.off('click.modal-backdrop').on('click.modal-backdrop', function(e) {
                            if ($(e.target).is('#orderDetailsModal')) {
                                e.stopPropagation();
                                e.preventDefault();
                                return false;
                            }
                        });
                        
                        // Empêcher la propagation des clics dans le contenu
                        $modal.find('.modal-content').off('click').on('click', function(e) {
                            e.stopPropagation();
                        });
                        
                        console.log('Modal ouverte avec succès');
                    } catch (error) {
                        console.error('Erreur lors de l\'ouverture de la modal:', error);
                        // Fallback : afficher manuellement
                        $modal.addClass('show');
                        $modal.css('display', 'block');
                        $('body').addClass('modal-open');
                        if ($('.modal-backdrop').length === 0) {
                            $('body').append('<div class="modal-backdrop fade show"></div>');
                        }
                    }
                }, 100);
                })
                .fail(function(xhr, status, error) {
                    console.error('Erreur lors du chargement des détails:', error);
                    console.error('Status:', status);
                    console.error('Response:', xhr.responseText);
                    alert('Erreur : Impossible de charger les détails de la commande. Veuillez réessayer.\n\nErreur: ' + error);
                });
        }
        
        function closeOrderModal() {
            console.log('Fermeture de la modal...');
            
            var $modal = $('#orderDetailsModal');
            
            if ($modal.length === 0) {
                console.warn('Modal element non trouvé');
                return;
            }
            
            // Fermer la modal avec Bootstrap/jQuery
            $modal.modal('hide');
            
            // Nettoyer après un court délai pour s'assurer que Bootstrap a terminé
            setTimeout(function() {
                // Supprimer tous les backdrops
                $('.modal-backdrop').remove();
                
                // Réinitialiser le body
                $('body').removeClass('modal-open');
                $('body').css({
                    overflow: '',
                    paddingRight: ''
                });
                
                // S'assurer que la modal est cachée
                $modal.removeClass('show');
                $modal.css('display', 'none');
                
                console.log('Modal fermée');
            }, 300);
        }
        
        // Exposer la fonction globalement pour pouvoir l'appeler depuis la console
        window.closeOrderModal = closeOrderModal;
        
        // Gestion globale de la fermeture de modal avec Escape (désactivée car keyboard: false)
        // La modal ne se fermera pas avec Escape grâce à keyboard: false
        
        // Empêcher la fermeture de la modal au clic sur le backdrop
        $(document).on('click', '#orderDetailsModal', function(e) {
            // Si le clic est directement sur la modal (pas sur le contenu), ne pas fermer
            if ($(e.target).is('#orderDetailsModal')) {
                e.stopPropagation();
                e.preventDefault();
                return false;
            }
        });
        
        // Empêcher la propagation des clics à l'intérieur du contenu de la modal
        $(document).on('click', '#orderDetailsModal .modal-content', function(e) {
            e.stopPropagation();
        });
        
        // Écouter les événements de fermeture de Bootstrap pour nettoyer
        $('#orderDetailsModal').on('hidden.bs.modal', function() {
            $('.modal-backdrop').remove();
            $('body').removeClass('modal-open');
            $('body').css({overflow: '', paddingRight: ''});
        });

        function updateOrderStatus(commandeId) {
            var newStatus = $('#newStatus').val();
            
            // Protection supplémentaire côté client : empêcher l'annulation via ce dropdown
            if (newStatus === "Annulée") {
                alert('⚠️ Pour annuler une commande, veuillez utiliser le bouton "Annuler la commande" et fournir une raison d\'annulation.');
                return;
            }
            
            $.post('@Url.Action("UpdateStatus", "Admin")', { commandeId: commandeId, nouveauStatut: newStatus }, function (result) {
                if (result && result.success) {
                    alert(' Statut mis à jour avec succès');
                    location.reload();
                } else {
                    var errorMsg = result && result.message ? result.message : 'Erreur lors de la mise à jour';
                    alert(' Erreur : ' + errorMsg);
                }
            }).fail(function(xhr, status, error) {
                var errorMessage = 'Une erreur est survenue lors de la mise à jour du statut';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                }
                alert(' Erreur : ' + errorMessage);
            });
        }
        
        function showCancelForm(commandeId) {
            $('#cancelForm_' + commandeId).slideDown(200);
            $('#raisonAnnulation_' + commandeId).focus();
        }
        
        function hideCancelForm(commandeId) {
            $('#cancelForm_' + commandeId).slideUp(200);
            $('#raisonAnnulation_' + commandeId).val('');
        }
        
        function cancelOrder(commandeId) {
            var raison = $('#raisonAnnulation_' + commandeId).val().trim();
            
            // Validation côté client
            if (!raison || raison === '') {
                alert('Veuillez indiquer la raison d\'annulation');
                $('#raisonAnnulation_' + commandeId).focus();
                return;
            }
            
            if (raison.length < 10) {
                alert('La raison d\'annulation doit contenir au moins 10 caractères');
                $('#raisonAnnulation_' + commandeId).focus();
                return;
            }
            
            // Confirmation avec message amélioré
            if (!confirm('⚠️ Attention : Annulation de commande\n\nÊtes-vous sûr de vouloir annuler cette commande ?\n\nCette action est irréversible et la raison d\'annulation sera enregistrée.')) {
                return;
            }
            
            // Désactiver le bouton pendant le traitement
            var $btn = $('.btn-confirm-cancel');
            var originalText = $btn.html();
            $btn.prop('disabled', true).html('Traitement...');
            
            // Récupérer le token antiforgery si disponible
            var token = $('input[name="__RequestVerificationToken"]').val();
            var requestData = { 
                commandeId: commandeId, 
                raisonAnnulation: raison 
            };
            
            // Ajouter le token si disponible
            if (token) {
                requestData.__RequestVerificationToken = token;
            }
            
            $.ajax({
                url: '@Url.Action("Cancel", "Admin")',
                type: 'POST',
                data: requestData,
                dataType: 'json',
                contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                success: function (result) {
                    if (result && result.success) {
                        alert('✅ Commande annulée avec succès');
                        location.reload();
                    } else {
                        var errorMsg = result && result.message ? result.message : 'Erreur lors de l\'annulation';
                        alert('❌ Erreur : ' + errorMsg);
                        $btn.prop('disabled', false).html(originalText);
                    }
                },
                error: function (xhr, status, error) {
                    var errorMessage = 'Une erreur est survenue lors de l\'annulation de la commande';
                    
                    // Gestion détaillée des erreurs
                    if (xhr.status === 400) {
                        errorMessage = 'Requête invalide. Vérifiez les données saisies.';
                    } else if (xhr.status === 404) {
                        errorMessage = 'La commande n\'a pas été trouvée.';
                    } else if (xhr.status === 500) {
                        errorMessage = 'Erreur serveur. Veuillez contacter l\'administrateur.';
                    }
                    
                    // Essayer d'extraire le message d'erreur de la réponse
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    } else if (xhr.responseText) {
                        try {
                            var errorResponse = JSON.parse(xhr.responseText);
                            if (errorResponse.message) {
                                errorMessage = errorResponse.message;
                            } else if (errorResponse.Message) {
                                errorMessage = errorResponse.Message;
                            }
                        } catch (e) {
                            // Si ce n'est pas du JSON, essayer d'extraire un message d'erreur HTML
                            if (xhr.responseText.indexOf('message') !== -1) {
                                var match = xhr.responseText.match(/message["\']?\s*[:=]\s*["\']?([^"\'<]+)/i);
                                if (match && match[1]) {
                                    errorMessage = match[1].trim();
                                }
                            }
                        }
                    }
                    
                    console.error('Erreur d\'annulation:', {
                        status: xhr.status,
                        statusText: xhr.statusText,
                        responseText: xhr.responseText,
                        error: error
                    });
                    
                    alert('❌ Erreur : ' + errorMessage);
                    $btn.prop('disabled', false).html(originalText);
                }
            });
        }
        
        // Pagination functions for order items
        function renderOrderItemsPage(page) {
            if (!window.orderItemsData) return;
            
            var items = window.orderItemsData;
            var itemsPerPage = window.orderItemsPerPage;
            var start = (page - 1) * itemsPerPage;
            var end = start + itemsPerPage;
            var pageItems = items.slice(start, end);
            
            var html = '';
            pageItems.forEach(function(item) {
                if (item && item.Produit) {
                    html += '<tr class="order-item-row">' +
                        '<td style="width: 70%;">' +
                        '<div class="order-item-name">' + (item.Produit.Nom || 'Produit inconnu') + '</div>' +
                        '<div class="order-item-quantity">Quantité: ' + (item.Quantite || 0) + '</div>' +
                        '</td>' +
                        '<td style="width: 30%;" class="order-item-price">' +
                        '<strong>' + (item.TotalLigne || 0).toFixed(2) + ' MAD</strong>' +
                        '</td>' +
                        '</tr>';
                }
            });
            
            $('#orderItemsBody').html(html);
            window.orderItemsCurrentPage = page;
            
            // Update pagination controls
            updatePaginationControls();
        }
        
        function changeOrderItemsPage(direction) {
            var newPage = window.orderItemsCurrentPage + direction;
            if (newPage >= 1 && newPage <= window.orderItemsTotalPages) {
                renderOrderItemsPage(newPage);
            }
        }
        
        function goToOrderItemsPage(page) {
            if (page >= 1 && page <= window.orderItemsTotalPages) {
                renderOrderItemsPage(page);
            }
        }
        
        function updatePaginationControls() {
            if (!window.orderItemsTotalPages) return;
            
            var currentPage = window.orderItemsCurrentPage;
            var totalPages = window.orderItemsTotalPages;
            
            // Update page number display
            var currentPageSpan = $('#currentPage');
            if (currentPageSpan.length) {
                currentPageSpan.text(currentPage);
            }
            
            // Update prev/next buttons
            $('.btn-pagination-prev').prop('disabled', currentPage === 1);
            $('.btn-pagination-next').prop('disabled', currentPage === totalPages);
            
            // Update page number buttons
            $('.btn-page-number').removeClass('active');
            var activeBtn = $('.btn-page-number').eq(currentPage - 1);
            if (activeBtn.length) {
                activeBtn.addClass('active');
            }
        }

        // Auto-filter Logic
        $(function() {
            var $form = $('.filter-form');
            var $applyBtn = $('.btn-filter-apply');
            var debounceTimer;

            // Hide apply button initially
            $applyBtn.hide();

            // Function to submit form
            function submitForm() {
                $form.submit();
            }

            // Debounce for text inputs (search, amounts)
            $('.search-input, .amount-filter').on('input', function() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(submitForm, 600); // 600ms delay to wait for typing
            });

            // Immediate submit for select and date
            $('.status-filter, .date-filter').on('change', function() {
                submitForm();
            });
        });
    </script>
}
