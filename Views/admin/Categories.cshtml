@model List<E_Commerce_Cooperatives.Models.ECommerceDbContext.CategorieStats>
@{
    ViewBag.Title = "Gestion des Catégories";
    Layout = "~/Views/Admin/_AdminLayout.cshtml";
}

<div class="admin-page">
    <!-- Header with Search - Matching Image 0 -->
    <div class="admin-page-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div class="search-form" style="flex: 1; max-width: 400px;">
            <div class="search-input-wrapper" style="position: relative;">
                <i class="fas fa-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #95A5A6;"></i>
                <input type="text" id="catSearchInput" placeholder="Rechercher une catégorie..." class="form-input" style="padding-left: 40px; border-radius: 8px; border: 1px solid #D09E86;" autocomplete="off" />
            </div>
        </div>
        <div class="header-notifications" style="display: flex; gap: 20px; align-items: center;">
            <i class="far fa-bell" style="font-size: 20px; color: #305C7D; position: relative;">
                <span style="position: absolute; top: -8px; right: -8px; background: #C06C50; color: white; font-size: 10px; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">3</span>
            </i>
            <div style="width: 35px; height: 35px; background: #305C7D; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">A</div>
        </div>
    </div>

    <!-- Title Section -->
    <div class="page-title-section" style="margin-bottom: 25px;">
        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
            <div>
                <h1 class="admin-page-title" style="margin-bottom: 5px;">Gestion des Catégories</h1>
                <p class="admin-page-subtitle">Organisez vos produits par secteurs</p>
            </div>
            <button class="btn-primary-action" onclick="openAddModal()">
                <i class="fas fa-plus"></i> Nouvelle Catégorie
            </button>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="stats-cards" style="margin-bottom: 30px;">
        <div class="stat-card" style="background: #FDFBF7;">
            <div class="stat-value">@ViewBag.TotalCategories</div>
            <div class="stat-label">Total catégories</div>
        </div>
        <div class="stat-card" style="background: #FDFBF7;">
            <div class="stat-value">@ViewBag.ActiveCategories</div>
            <div class="stat-label">Actives</div>
        </div>
        <div class="stat-card" style="background: #FDFBF7;">
            <div class="stat-value">@ViewBag.TotalProductsInCategory</div>
            <div class="stat-label">Produits associés</div>
        </div>
    </div>

    <!-- Categories Grid - Matching Image 0 -->
    <div class="categories-grid" id="categoriesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
        @foreach (var cat in Model)
        {
            <div class="category-card" data-name="@cat.Nom.ToLower()">
                <div class="category-card-header" style="height: 180px; position: relative; border-radius: 12px 12px 0 0; overflow: hidden; background: #F5F3EF; display: flex; align-items: center; justify-content: center;">
                    @if (!string.IsNullOrEmpty(cat.ImageUrl))
                    {
                        <img src="@Url.Content(cat.ImageUrl)" alt="@cat.Nom" class="category-image-real" style="width: 100%; height: 100%; object-fit: cover;" />
                    }
                    else
                    {
                        <div class="category-folder-icon" style="font-size: 50px; color: #A0A0A0;">
                            <i class="far fa-folder-open"></i>
                        </div>
                    }

                    <div class="category-card-actions" style="position: absolute; bottom: 15px; right: 15px; display: flex; gap: 10px;">
                        <button onclick="openEditModal(@cat.CategorieId)" class="btn-card-action" title="Modifier" style="background: #EADBC0; color: #2C3E50; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-pen"></i>
                        </button>
                        <button onclick="deleteCategory(@cat.CategorieId, '@cat.Nom')" class="btn-card-action" title="Supprimer" style="background: #EB5757; color: white; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>

                <div class="category-card-body" style="padding: 20px; background: white; border-radius: 0 0 12px 12px; border: 1px solid #F5F3EF; border-top: none;">
                    <div class="card-title-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 class="category-title" style="font-family: 'Georgia', serif; color: #305C7D; font-size: 18px; margin: 0; font-weight: 700;">@cat.Nom</h3>
                        <span class="badge @(cat.EstActive ? "badge-dispo" : "badge-stock-faible")" style="font-size: 10px; padding: 4px 10px; border-radius: 12px; font-weight: 700; text-transform: uppercase; @(cat.EstActive ? "background: #7D8453; color: white;" : "background: #EB5757; color: white;")">
                            @(cat.EstActive ? "Active" : "Inactive")
                        </span>
                    </div>
                    <p class="category-card-desc" style="font-size: 13px; color: #5D6D7E; margin-bottom: 15px; line-height: 1.4; height: 40px; overflow: hidden;">
                        @(string.IsNullOrEmpty(cat.Description) ? "Aucune description disponible pour cette catégorie." : (cat.Description.Length > 80 ? cat.Description.Substring(0, 77) + "..." : cat.Description))
                    </p>
                    <div class="category-card-footer" style="color: #305C7D; font-weight: 600; font-size: 13px;">
                        @cat.NombreProduits produits
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Message si aucun résultat -->
    <div id="noResults" style="display: none; text-align: center; padding: 60px 20px;">
        <i class="fas fa-search" style="font-size: 48px; color: #95A5A6; margin-bottom: 20px;"></i>
        <h3 style="color: #305C7D; font-size: 20px;">Aucune catégorie trouvée</h3>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function() {
            // Real-time Search
            $('#catSearchInput').on('keyup', function() {
                var term = $(this).val().toLowerCase();
                var visibleCount = 0;
                $('.category-card').each(function() {
                    var name = $(this).data('name');
                    if (name.indexOf(term) > -1) {
                        $(this).show();
                        visibleCount++;
                    } else {
                        $(this).hide();
                    }
                });
                if (visibleCount === 0) $('#noResults').show(); else $('#noResults').hide();
            });

            // Form Submit (AJAX) - Delegated event for robustness
            $(document).on('submit', '#categorieForm', function(e) {
                e.preventDefault();
                var formData = new FormData(this);
                var id = $('#CategorieId').val();
                var url = id == "0" ? '@Url.Action("AjouterCategorie", "Admin")' : '@Url.Action("ModifierCategorie", "Admin")';

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            $('#categorieModal').modal('hide');
                            location.reload();
                        } else {
                            alert('Erreur: ' + (response.errors ? response.errors.join("\n") : response.message));
                        }
                    },
                    error: function() {
                        alert('Une erreur est survenue lors de l\'enregistrement.');
                    }
                });
            });
        });

        function openAddModal() {
            $('#categorieForm')[0].reset();
            $('#CategorieId').val("0");
            $('#catModalTitle').text("Nouvelle Catégorie");
            // Fix for backdrop issue: move modal to body
            $('#categorieModal').appendTo("body").modal('show');
        }

        function openEditModal(id) {
            $.get('@Url.Action("GetCategorie", "Admin")', { id: id }, function(response) {
                if (response.success) {
                    var c = response.categorie;
                    $('#CategorieId').val(c.CategorieId);
                    $('#Nom').val(c.Nom);
                    $('#Description').val(c.Description);
                    $('#ImageUrl').val(c.ImageUrl);
                    $('#EstActive').prop('checked', c.EstActive);

                    $('#catModalTitle').text("Modifier la Catégorie");
                    // Fix for backdrop issue: move modal to body
                    $('#categorieModal').appendTo("body").modal('show');
                } else {
                    alert(response.message);
                }
            });
        }

        function deleteCategory(id, nom) {
            if (confirm('Voulez-vous vraiment supprimer la catégorie "' + nom + '" ?')) {
                $.post('@Url.Action("SupprimerCategorie", "Admin")', { id: id }, function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert('Erreur: ' + response.message);
                    }
                });
            }
        }
    </script>
}

<!-- Modal Moved Here (End of file to avoid z-index/nesting issues) -->
<div id="categorieModal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="catModalTitle">Catégorie</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="categorieForm" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="CategorieId" name="CategorieId" value="0" />
                    
                    <div class="form-group mb-3">
                        <label class="form-label">Nom de la catégorie</label>
                        <input type="text" id="Nom" name="Nom" class="form-input" required />
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label">Description</label>
                        <textarea id="Description" name="Description" class="form-input" rows="3"></textarea>
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label">Image/Icône (Optionnel)</label>
                        <input type="file" id="imageFile" name="imageFile" class="form-input" accept="image/*" />
                        <input type="hidden" id="ImageUrl" name="ImageUrl" />
                    </div>

                    <div class="form-check mb-4">
                        <input type="checkbox" class="form-check-input" id="EstActive" name="EstActive" value="true" checked />
                        <label class="form-check-label" for="EstActive">Catégorie active</label>
                    </div>

                    <div class="form-footer mt-4">
                        <button type="button" class="btn-cancel" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn-save">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
