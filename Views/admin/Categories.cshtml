@model List<E_Commerce_Cooperatives.Models.ECommerceDbContext.CategorieStats>
@{
    ViewBag.Title = "Gestion des Catégories";
    Layout = "~/Views/Admin/_AdminLayout.cshtml";
}

<style>
    /* Fix pour le modal - Z-index correct */
    .modal-backdrop {
        z-index: 1040 !important;
    }
    
    #categorieModal {
        z-index: 1050 !important;
    }
    
    #categorieModal .modal-dialog {
        z-index: 1055 !important;
    }
    
    /* Styles du modal */
    .modal-content {
        border-radius: 15px;
        border: none;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    
    .modal-header {
        background: linear-gradient(135deg, #305C7D 0%, #3D7BA8 100%);
        color: white;
        border-radius: 15px 15px 0 0;
        padding: 20px 25px;
        border-bottom: none;
    }
    
    .modal-title {
        font-family: 'Georgia', serif;
        font-size: 22px;
        font-weight: 700;
    }
    
    .btn-close {
        filter: brightness(0) invert(1);
        opacity: 0.8;
    }
    
    .btn-close:hover {
        opacity: 1;
    }
    
    .modal-body {
        padding: 30px 25px;
    }
    
    .form-label {
        font-weight: 600;
        color: #305C7D;
        margin-bottom: 8px;
        font-size: 14px;
    }
    
    .form-input {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #D09E86;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
    }
    
    .form-input:focus {
        outline: none;
        border-color: #305C7D;
        box-shadow: 0 0 0 3px rgba(48, 92, 125, 0.1);
    }
    
    .form-check {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px;
        background: #F5F3EF;
        border-radius: 8px;
    }
    
    .form-check-input {
        width: 20px;
        height: 20px;
        border: 2px solid #305C7D;
        cursor: pointer;
    }
    
    .form-check-input:checked {
        background-color: #7D8453;
        border-color: #7D8453;
    }
    
    .form-check-label {
        font-weight: 500;
        color: #2C3E50;
        cursor: pointer;
        margin: 0;
    }
    
    .form-footer {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        padding-top: 20px;
        border-top: 1px solid #E8E8E8;
    }
    
    .btn-cancel {
        padding: 12px 25px;
        background: #95A5A6;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-cancel:hover {
        background: #7F8C8D;
        transform: translateY(-2px);
    }
    
    .btn-save {
        padding: 12px 30px;
        background: linear-gradient(135deg, #7D8453 0%, #9BA36C 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-save:hover {
        background: linear-gradient(135deg, #6B7145 0%, #8A9158 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(125, 132, 83, 0.3);
    }
    
    .btn-primary-action {
        padding: 12px 25px;
        background: linear-gradient(135deg, #305C7D 0%, #3D7BA8 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-primary-action:hover {
        background: linear-gradient(135deg, #244A63 0%, #2F6289 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(48, 92, 125, 0.3);
    }
</style>

<div class="admin-page">
    <!-- Header with Search -->
    <div class="admin-page-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div class="search-form" style="flex: 1; max-width: 400px;">
            <div class="search-input-wrapper" style="position: relative;">
                <i class="fas fa-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #95A5A6;"></i>
                <input type="text" id="catSearchInput" placeholder="Rechercher une catégorie..." class="form-input" style="padding-left: 40px; border-radius: 8px; border: 1px solid #D09E86;" autocomplete="off" />
            </div>
        </div>
        <div class="header-notifications" style="display: flex; gap: 20px; align-items: center;">
            <i class="far fa-bell" style="font-size: 20px; color: #305C7D; position: relative;">
                <span style="position: absolute; top: -8px; right: -8px; background: #C06C50; color: white; font-size: 10px; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">3</span>
            </i>
            <div style="width: 35px; height: 35px; background: #305C7D; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">A</div>
        </div>
    </div>

    <!-- Title Section -->
    <div class="page-title-section" style="margin-bottom: 25px;">
        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
            <div>
                <h1 class="admin-page-title" style="margin-bottom: 5px; font-family: 'Georgia', serif; color: #305C7D; font-size: 32px; font-weight: 700;">Gestion des Catégories</h1>
                <p class="admin-page-subtitle" style="color: #5D6D7E; font-size: 14px;">Organisez vos produits par secteurs</p>
            </div>
            <button class="btn-primary-action" onclick="openAddModal()">
                <i class="fas fa-plus"></i> Nouvelle Catégorie
            </button>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="stats-cards" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
        <div class="stat-card" style="background: #FDFBF7; padding: 25px; border-radius: 12px; border: 1px solid #EADBC0;">
            <div class="stat-value" style="font-size: 36px; font-weight: 700; color: #305C7D; margin-bottom: 5px;">@ViewBag.TotalCategories</div>
            <div class="stat-label" style="font-size: 14px; color: #5D6D7E; font-weight: 500;">Total catégories</div>
        </div>
        <div class="stat-card" style="background: #FDFBF7; padding: 25px; border-radius: 12px; border: 1px solid #EADBC0;">
            <div class="stat-value" style="font-size: 36px; font-weight: 700; color: #7D8453; margin-bottom: 5px;">@ViewBag.ActiveCategories</div>
            <div class="stat-label" style="font-size: 14px; color: #5D6D7E; font-weight: 500;">Actives</div>
        </div>
        <div class="stat-card" style="background: #FDFBF7; padding: 25px; border-radius: 12px; border: 1px solid #EADBC0;">
            <div class="stat-value" style="font-size: 36px; font-weight: 700; color: #C06C50; margin-bottom: 5px;">@ViewBag.TotalProductsInCategory</div>
            <div class="stat-label" style="font-size: 14px; color: #5D6D7E; font-weight: 500;">Produits associés</div>
        </div>
    </div>

    <!-- Categories Grid -->
    <div class="categories-grid" id="categoriesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
        @foreach (var cat in Model)
        {
            <div class="category-card" data-name="@cat.Nom.ToLower()" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.3s ease;">
                <div class="category-card-header" style="height: 180px; position: relative; background: #F5F3EF; display: flex; align-items: center; justify-content: center;">
                    @if (!string.IsNullOrEmpty(cat.ImageUrl))
                    {
                        <img src="@Url.Content(cat.ImageUrl)" alt="@cat.Nom" class="category-image-real" style="width: 100%; height: 100%; object-fit: cover;" />
                    }
                    else
                    {
                        <div class="category-folder-icon" style="font-size: 50px; color: #A0A0A0;">
                            <i class="far fa-folder-open"></i>
                        </div>
                    }

                    <div class="category-card-actions" style="position: absolute; bottom: 15px; right: 15px; display: flex; gap: 10px;">
                        <button onclick="openEditModal(@cat.CategorieId)" class="btn-card-action" title="Modifier" style="background: #EADBC0; color: #2C3E50; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                            <i class="fas fa-pen"></i>
                        </button>
                        <button onclick="deleteCategory(@cat.CategorieId, '@cat.Nom')" class="btn-card-action" title="Supprimer" style="background: #EB5757; color: white; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>

                <div class="category-card-body" style="padding: 20px;">
                    <div class="card-title-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 class="category-title" style="font-family: 'Georgia', serif; color: #305C7D; font-size: 18px; margin: 0; font-weight: 700;">@cat.Nom</h3>
                        <span class="badge" style="font-size: 10px; padding: 4px 10px; border-radius: 12px; font-weight: 700; text-transform: uppercase; @(cat.EstActive ? "background: #7D8453;" : "background: #EB5757;") color: white;">
                            @(cat.EstActive ? "Active" : "Inactive")
                        </span>
                    </div>
                    <p class="category-card-desc" style="font-size: 13px; color: #5D6D7E; margin-bottom: 15px; line-height: 1.4; height: 40px; overflow: hidden;">
                        @(string.IsNullOrEmpty(cat.Description) ? "Aucune description disponible pour cette catégorie." : (cat.Description.Length > 80 ? cat.Description.Substring(0, 77) + "..." : cat.Description))
                    </p>
                    <div class="category-card-footer" style="color: #305C7D; font-weight: 600; font-size: 13px;">
                        <i class="fas fa-box" style="margin-right: 5px;"></i> @cat.NombreProduits produits
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Message si aucun résultat -->
    <div id="noResults" style="display: none; text-align: center; padding: 60px 20px;">
        <i class="fas fa-search" style="font-size: 48px; color: #95A5A6; margin-bottom: 20px;"></i>
        <h3 style="color: #305C7D; font-size: 20px; margin-bottom: 10px;">Aucune catégorie trouvée</h3>
        <p style="color: #5D6D7E;">Essayez avec un autre terme de recherche</p>
    </div>
</div>

<!-- Modal Bootstrap 4 - Placé en dehors de admin-page -->
<div id="categorieModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="catModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="catModalTitle">Nouvelle Catégorie</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="background: none; border: none; font-size: 28px; color: white; opacity: 0.8; cursor: pointer; padding: 0; margin: 0; line-height: 1;">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="categorieForm" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="CategorieId" name="CategorieId" value="0" />
                    
                    <div class="form-group mb-3">
                        <label class="form-label">Nom de la catégorie *</label>
                        <input type="text" id="Nom" name="Nom" class="form-input" placeholder="Ex: Électronique, Vêtements..." required />
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label">Description</label>
                        <textarea id="Description" name="Description" class="form-input" rows="3" placeholder="Décrivez cette catégorie..." style="resize: vertical;"></textarea>
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label">Image/Icône (Optionnel)</label>
                        <input type="file" id="imageFile" name="imageFile" class="form-input" accept="image/*" style="padding: 10px;" />
                        <input type="hidden" id="ImageUrl" name="ImageUrl" />
                        <small style="color: #5D6D7E; font-size: 12px; display: block; margin-top: 5px;">
                            <i class="fas fa-info-circle"></i> Formats acceptés: JPG, PNG, GIF (Max 5MB)
                        </small>
                    </div>

                    <div class="form-check mb-4">
                        <input type="checkbox" class="form-check-input" id="EstActive" name="EstActive" value="true" checked />
                        <label class="form-check-label" for="EstActive">
                            <i class="fas fa-check-circle" style="color: #7D8453; margin-right: 5px;"></i>
                            Catégorie active et visible
                        </label>
                    </div>

                    <div class="form-footer">
                        <button type="button" class="btn-cancel" data-dismiss="modal">
                            <i class="fas fa-times"></i> Annuler
                        </button>
                        <button type="submit" class="btn-save">
                            <i class="fas fa-save"></i> Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function() {
            // Real-time Search
            $('#catSearchInput').on('keyup', function() {
                var term = $(this).val().toLowerCase();
                var visibleCount = 0;
                
                $('.category-card').each(function() {
                    var name = $(this).data('name');
                    if (name.indexOf(term) > -1) {
                        $(this).show();
                        visibleCount++;
                    } else {
                        $(this).hide();
                    }
                });
                
                if (visibleCount === 0) {
                    $('#noResults').show();
                    $('#categoriesGrid').hide();
                } else {
                    $('#noResults').hide();
                    $('#categoriesGrid').show();
                }
            });

            // Form Submit (AJAX)
            $('#categorieForm').on('submit', function(e) {
                e.preventDefault();
                
                var formData = new FormData(this);
                var id = $('#CategorieId').val();
                var url = id == "0" ? '@Url.Action("AjouterCategorie", "Admin")' : '@Url.Action("ModifierCategorie", "Admin")';

                // Désactiver le bouton submit pour éviter double soumission
                var $submitBtn = $(this).find('button[type="submit"]');
                var originalText = $submitBtn.html();
                $submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Enregistrement...');

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            $('#categorieModal').modal('hide');
                            location.reload();
                        } else {
                            alert('Erreur: ' + (response.errors ? response.errors.join("\n") : response.message));
                            $submitBtn.prop('disabled', false).html(originalText);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Une erreur est survenue lors de l\'enregistrement. Veuillez réessayer.');
                        $submitBtn.prop('disabled', false).html(originalText);
                        console.error('Error:', error);
                    }
                });
            });

            // Reset form when modal is hidden
            $('#categorieModal').on('hidden.bs.modal', function () {
                $('#categorieForm')[0].reset();
                $('#CategorieId').val("0");
            });
        });

        function openAddModal() {
            // Reset le formulaire
            $('#categorieForm')[0].reset();
            $('#CategorieId').val("0");
            $('#catModalTitle').text("Nouvelle Catégorie");
            $('#EstActive').prop('checked', true);
            
            // Ouvre le modal Bootstrap 4
            $('#categorieModal').modal('show');
        }

        function openEditModal(id) {
            $.ajax({
                url: '@Url.Action("GetCategorie", "Admin")',
                type: 'GET',
                data: { id: id },
                success: function(response) {
                    if (response.success) {
                        var c = response.categorie;
                        $('#CategorieId').val(c.CategorieId);
                        $('#Nom').val(c.Nom);
                        $('#Description').val(c.Description);
                        $('#ImageUrl').val(c.ImageUrl);
                        $('#EstActive').prop('checked', c.EstActive);
                        $('#catModalTitle').text("Modifier la Catégorie");
                        
                        // Ouvre le modal Bootstrap 4
                        $('#categorieModal').modal('show');
                    } else {
                        alert('Erreur: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('Erreur lors du chargement de la catégorie.');
                    console.error('Error:', error);
                }
            });
        }

        function deleteCategory(id, nom) {
            if (confirm('⚠️ Voulez-vous vraiment supprimer la catégorie "' + nom + '" ?\n\nCette action est irréversible.')) {
                $.ajax({
                    url: '@Url.Action("SupprimerCategorie", "Admin")',
                    type: 'POST',
                    data: { id: id },
                    success: function(response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert('Erreur: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Erreur lors de la suppression.');
                        console.error('Error:', error);
                    }
                });
            }
        }
    </script>
}

