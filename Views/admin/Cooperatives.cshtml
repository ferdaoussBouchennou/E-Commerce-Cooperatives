@model IEnumerable<E_Commerce_Cooperatives.Models.Cooperative>
@{
    ViewBag.Title = "Gestion des Coopératives";
    Layout = "~/Views/Admin/_AdminLayout.cshtml";
}

<link rel="stylesheet" href="~/Content/AdminCop.css" />

<div class="admin-page">
    <div class="admin-header-row" style="display: flex; justify-content: space-between; align-items: center; gap: 20px; margin-bottom: 30px;">
        <div class="admin-page-header" style="margin-bottom: 0;">
            <h1 class="admin-page-title" style="margin-bottom: 0;">Gestion des Coopératives</h1>
            <p class="admin-page-subtitle" style="margin-bottom: 0;">Gérez les coopératives partenaires</p>
        </div>

        <div style="flex: 1; max-width: 500px;">
            <form method="get" action="@Url.Action("Cooperatives", "Admin")">
                <div class="search-box position-relative">
                    <i class="fas fa-search position-absolute" style="left: 15px; top: 50%; transform: translateY(-50%); color: #95A5A6;"></i>
                    <input type="text" id="coopSearchInput" name="searchTerm" value="@ViewBag.SearchTerm" class="form-control" placeholder="Rechercher une coopérative ou une ville..." style="padding-left: 45px; border-radius: 10px; border: 1px solid #D09E86; width: 100%;">
                </div>
            </form>
        </div>

        <div class="admin-actions">
            <button class="btn btn-primary" onclick="openAddModal()" style="background-color: #305C7D; border: none; padding: 10px 20px; border-radius: 8px; white-space: nowrap;">
                <i class="fas fa-plus mr-2"></i> Ajouter une coopérative
            </button>
        </div>
    </div>

    <!-- Grid Section -->
    <div class="cooperatives-grid">
        @foreach (var coop in Model)
        {
            <div id="dataCoop" class="coop-card"
                 data-coop-name="@coop.Nom.ToLower()"
                 data-coop-desc="@((coop.Description ?? "").ToLower())"
                 data-coop-ville="@coop.Ville.ToLower()">
                <div class="coop-card-header">
                    <div class="coop-icon-container">
                        <i class="fas fa-university"></i>
                    </div>
                    @if (coop.EstActive)
                    {
                        <span class="coop-badge-active">Active</span>
                    }
                </div>
                <div class="coop-card-body">
                    <h3 class="coop-name">@coop.Nom</h3>
                    <p class="coop-desc">@coop.Description</p>
                    
                    <div class="coop-info-grid">
                        <div class="coop-info-row">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>@coop.Ville</span>
                        </div>
                        <div class="coop-info-row">
                            <i class="fas fa-phone"></i>
                            <span>@(string.IsNullOrEmpty(coop.Telephone) ? "NC" : coop.Telephone)</span>
                        </div>
                        <div class="coop-info-row">
                            <i class="fas fa-box"></i>
                            <span>@coop.ProductCount produits</span>
                        </div>
                        <div class="coop-info-row">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Depuis @coop.DateCreation.ToString("yyyy")</span>
                        </div>
                    </div>
                </div>
                <div class="coop-card-footer">
                    <button class="btn-modifier" onclick="openEditModal(@coop.CooperativeId)">
                        <i class="fas fa-edit"></i> Modifier
                    </button>
                    <button class="btn-supprimer" onclick="deleteCooperative(@coop.CooperativeId, '@coop.Nom')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        }
    </div>
</div>

<!-- Modal logic would go here, similar to Categories or Products -->

<!-- Modal Coopérative -->
<div id="cooperativeModal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 600px;">
        <div class="modal-content" style="background-color: #F5F3EF; border-radius: 12px; border: none; box-shadow: 0 15px 50px rgba(0,0,0,0.1);">
            <div class="modal-header" style="border: none; padding: 25px 35px 10px 35px; display: flex; justify-content: space-between; align-items: center;">
                <h5 class="modal-title" id="coopModalTitle" style="font-family: 'Georgia', serif; color: #305C7D; font-size: 24px; font-weight: 700;">Nouvelle Coopérative</h5>
                <button type="button" class="close" onclick="closeModal()" style="background: none; border: none; font-size: 32px; color: #305C7D; opacity: 0.6; cursor: pointer; padding: 0; line-height: 1;">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 10px 35px 25px 35px;">
                <form id="cooperativeForm" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="CooperativeId" name="CooperativeId" value="0" />
                    
                    <div class="form-group mb-3">
                        <label class="form-label">Nom de la coopérative *</label>
                        <input type="text" id="Nom" name="Nom" class="form-control" required style="border-radius: 10px; border: 1px solid #D09E86; padding: 12px;" />
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label">Description</label>
                        <textarea id="Description" name="Description" class="form-control" rows="3" style="border-radius: 10px; border: 1px solid #D09E86; padding: 12px; resize: none;"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 form-group mb-3">
                            <label class="form-label">Ville *</label>
                            <input type="text" id="Ville" name="Ville" class="form-control" required style="border-radius: 10px; border: 1px solid #D09E86; padding: 12px;" />
                        </div>
                        <div class="col-md-6 form-group mb-3">
                            <label class="form-label">Téléphone</label>
                            <input type="text" id="Telephone" name="Telephone" class="form-control" style="border-radius: 10px; border: 1px solid #D09E86; padding: 12px;" />
                        </div>
                    </div>

                    <div class="form-check mb-4">
                        <input type="checkbox" class="form-check-input" id="EstActive" name="EstActive" value="true" checked />
                        <label class="form-check-label" for="EstActive">Coopérative active</label>
                    </div>

                    <div class="d-flex gap-3" style="gap: 15px;">
                        <button type="button" class="btn btn-default" onclick="closeModal()" style="flex: 1; border: 2px solid #305C7D; color: #305C7D; border-radius: 8px; padding: 12px; font-weight: 600;">Annuler</button>
                        <button type="submit" class="btn btn-primary" style="flex: 2; background-color: #305C7D; border: none; border-radius: 8px; padding: 12px; font-weight: 600;">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>

     // pour automatise la recherche 
           
          let searchTimeout;

        $('#coopSearchInput').on('keyup', function () {
            clearTimeout(searchTimeout);

            const term = $(this).val().trim().toLowerCase();

            searchTimeout = setTimeout(() => {
                let visibleCount = 0;

                $('.coop-card').each(function () {
                    const name = $(this).data('coop-name') || '';
                    const desc = $(this).data('coop-desc') || '';
                    const ville = $(this).data('coop-ville') || '';

                    const match =
                        name.includes(term) ||
                        desc.includes(term) ||
                        ville.includes(term);

                    $(this).toggle(match);

                    if (match) visibleCount++;
                });

                $('#noResults').toggle(visibleCount === 0);
                $('.cooperatives-grid').toggle(visibleCount > 0);

            }, 250); // debounce 250ms
        });


        $(document).ready(function() {
            // Form Submit (AJAX)
            $('#cooperativeForm').on('submit', function(e) {
                e.preventDefault();
                
                var formData = new FormData(this);
                var id = $('#CooperativeId').val();
                var url = id == "0" ? '@Url.Action("AjouterCooperative", "Admin")' : '@Url.Action("ModifierCooperative", "Admin")';

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            $('#cooperativeModal').modal('hide');
                            location.reload();
                        } else {
                            alert('Erreur: ' + response.message);
                        }
                    },
                    error: function() {
                        alert('Une erreur est survenue lors de l\'enregistrement.');
                    }
                });
            });
        });

        function openAddModal() {
            $('#cooperativeForm')[0].reset();
            $('#CooperativeId').val("0");
            $('#coopModalTitle').text("Nouvelle Coopérative");
            $('#EstActive').prop('checked', true);
            $('#cooperativeModal').appendTo('body').modal('show');
        }

        function openEditModal(id) {
            $.get('@Url.Action("GetCooperative", "Admin")', { id: id }, function(response) {
                if (response.success) {
                    var c = response.cooperative;
                    $('#CooperativeId').val(c.CooperativeId);
                    $('#Nom').val(c.Nom);
                    $('#Description').val(c.Description);
                    $('#Ville').val(c.Ville);
                    $('#Telephone').val(c.Telephone);
                    $('#Logo').val(c.Logo);
                    $('#EstActive').prop('checked', c.EstActive);
                    $('#coopModalTitle').text("Modifier la Coopérative");
                    $('#cooperativeModal').appendTo('body').modal('show');
                } else {
                    alert('Erreur: ' + response.message);
                }
            });
        }

        function closeModal() {
            $('#cooperativeModal').modal('hide');
        }


        function deleteCooperative(id, name) {
            if (confirm("Êtes-vous sûr de vouloir supprimer la coopérative '" + name + "' ?")) {
                $.post('@Url.Action("SupprimerCooperative", "Admin")', { id: id }, function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert("Erreur: " + response.message);
                    }
                });
            }
        }
          
    </script>
}
