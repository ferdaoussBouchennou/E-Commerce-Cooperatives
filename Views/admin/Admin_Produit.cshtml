@model List<E_Commerce_Cooperatives.Models.Produit>
@{
    ViewBag.Title = "Gestion des Produits";
    Layout = "~/Views/Admin/_AdminLayout.cshtml";

    var categories = ViewBag.Categories as List<E_Commerce_Cooperatives.Models.Categorie> ?? new List<E_Commerce_Cooperatives.Models.Categorie>();
    var cooperatives = ViewBag.Cooperatives as List<E_Commerce_Cooperatives.Models.Cooperative> ?? new List<E_Commerce_Cooperatives.Models.Cooperative>();
}

<div class="admin-page">
    <!-- Top Header - Simplified (Removed Search as requested) -->
    <div class="admin-page-header-row" style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 30px;">
        <div class="header-notifications" style="display: flex; gap: 20px; align-items: center;">
            <i class="far fa-bell" style="font-size: 20px; color: #305C7D; position: relative;">
                <span style="position: absolute; top: -8px; right: -8px; background: #C06C50; color: white; font-size: 10px; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: sans-serif;">3</span>
            </i>
            <div style="width: 35px; height: 35px; background: #305C7D; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">A</div>
        </div>
    </div>

    <!-- Page Title Section -->
    <div class="page-title-section" style="margin-bottom: 25px;">
        <h1 class="admin-page-title" style="margin-bottom: 5px;">Gestion des Produits</h1>
        <p class="admin-page-subtitle">Gérez votre catalogue de produits</p>
    </div>

    <!-- Filters Row -->
    <div class="admin-filters" style="margin-bottom: 25px;">
        <div class="filters-row" style="display: flex; gap: 15px; align-items: center;">
             <div class="search-box" style="flex: 1; max-width: 300px;">
                <input type="text" id="inlineSearch" placeholder="Rechercher un produit..." class="form-input" style="border-color: #D0D0D0; font-size: 13px;" />
            </div>

            <button class="btn-filter-icon" style="background: white; border: 1px solid #D0D0D0; padding: 10px; border-radius: 8px; color: #305C7D;">
                <i class="fas fa-filter"></i>
            </button>

            <select id="catFilter" class="form-input" style="width: 200px; border-color: #D0D0D0; font-size: 13px;">
                <option value="all">Toutes les catégories</option>
                @foreach (var cat in categories)
                {
                    <option value="@cat.CategorieId">@cat.Nom</option>
                }
            </select>

            <button class="btn-primary-action" onclick="openAddModal()" style="margin-left: auto; height: 42px;">
                <i class="fas fa-plus"></i> Ajouter un produit
            </button>
        </div>
    </div>

    <!-- Stats Cards - Matching Image 1 -->
    <div class="stats-cards">
        <div class="stat-card" style="background: #FDFBF7;">
            <div class="stat-value">@(ViewBag.Stats != null ? ViewBag.Stats["Total"] : 0)</div>
            <div class="stat-label">Total produits</div>
        </div>
        <div class="stat-card" style="background: #FDFBF7;">
            <div class="stat-value">@(ViewBag.Stats != null ? ViewBag.Stats["Disponibles"] : 0)</div>
            <div class="stat-label">Disponibles</div>
        </div>
        <div class="stat-card" style="background: #FDFBF7;">
            <div class="stat-value">@(ViewBag.Stats != null ? ViewBag.Stats["EnVedette"] : 0)</div>
            <div class="stat-label">En vedette</div>
        </div>
        <div class="stat-card" style="background: #FFF5F5;">
            <div class="stat-value" style="color: #EB5757;">@(ViewBag.Stats != null ? ViewBag.Stats["StockFaible"] : 0)</div>
            <div class="stat-label">Stock faible</div>
        </div>
    </div>

    <!-- Table Section -->
    <div class="admin-table-container" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03);">
        <table class="admin-table" style="width: 100%; border-collapse: separate; border-spacing: 0 10px;">
            <thead>
                <tr style="border-bottom: 2px solid #F5F3EF;">
                    <th style="padding: 15px; color: #6D6C6A; font-weight: 600;">Produit</th>
                    <th style="padding: 15px; color: #6D6C6A; font-weight: 600;">Catégorie</th>
                    <th style="padding: 15px; color: #6D6C6A; font-weight: 600;">Prix</th>
                    <th style="padding: 15px; color: #6D6C6A; font-weight: 600;">Stock</th>
                    <th style="padding: 15px; color: #6D6C6A; font-weight: 600;">Statut</th>
                    <th style="padding: 15px; text-align: right;"></th>
                </tr>
            </thead>
            <tbody id="productTableBody">
                @foreach (var p in Model)
                {
                    <tr class="product-row" data-name="@p.Nom.ToLower()" data-cat="@(p.CategorieId.HasValue ? p.CategorieId.Value.ToString() : "0")" style="background: white; transition: all 0.2s;">
                        <td style="padding: 15px; display: flex; align-items: center; gap: 15px;">
                            <div class="product-image-thumb" style="width: 40px; height: 40px; background: #F5F3EF; border-radius: 8px; flex-shrink: 0;">
                                @if (!string.IsNullOrEmpty(p.ImageUrl))
                                {
                                    <img src="@Url.Content(p.ImageUrl)" alt="@p.Nom" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;" />
                                }
                            </div>
                            <div style="display: flex; flex-direction: column;">
                                <span class="prod-name" style="font-weight: 600; color: #305C7D;">@p.Nom</span>
                                <span style="font-size: 12px; color: #95A5A6;">@(p.Cooperative != null ? p.Cooperative.Nom : "Coopérative")</span>
                            </div>
                        </td>
                        <td style="padding: 15px;">
                            <span style="background: #EADBC0; color: #2C3E50; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                @(p.Categorie != null ? p.Categorie.Nom : "Général")
                            </span>
                        </td>
                        <td style="padding: 15px; font-weight: 600; color: #305C7D;">
                            @p.Prix.ToString("0") MAD
                        </td>
                        <td style="padding: 15px;">
                             <span style="background: #7D8453; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                @p.StockTotal
                            </span>
                        </td>
                        <td style="padding: 15px; display: flex; gap: 8px; align-items: center;">
                            @if (p.EstDisponible)
                            {
                                <span style="background: #7D8453; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">Dispo</span>
                            }
                            else
                            {
                                <span style="background: #95A5A6; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">Indispo</span>
                            }

                            @if (p.EstEnVedette)
                            {
                                <span style="background: #C06C50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">Vedette</span>
                            }
                        </td>
                        <td style="padding: 15px; text-align: right;">
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button onclick="openEditModal(@p.ProduitId)" style="background: none; border: none; color: #305C7D; cursor: pointer; font-size: 16px;" title="Modifier">
                                    <i class="far fa-edit"></i>
                                </button>
                                <button onclick="deleteProduct(@p.ProduitId, '@p.Nom')" style="background: none; border: none; color: #EB5757; cursor: pointer; font-size: 16px;" title="Supprimer">
                                    <i class="far fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function() {
            // Real-time Search (KeyUp)
            $('#inlineSearch').on('keyup', function() {
                filterProducts();
            });

            // Category Filter
            $('#catFilter').on('change', function() {
                filterProducts();
            });

            function filterProducts() {
                var term = $('#inlineSearch').val().toLowerCase();
                var cat = $('#catFilter').val();

                $('.product-row').each(function() {
                    var name = $(this).data('name');
                    var rowCat = $(this).data('cat');
                    
                    var matchesSearch = name.indexOf(term) > -1;
                    var matchesCat = (cat === 'all' || rowCat === cat);

                    if (matchesSearch && matchesCat) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            }

            // Form Submit (AJAX) - Delegated event for robustness
            $(document).on('submit', '#produitForm', function(e) {
                e.preventDefault();
                var formData = new FormData(this);
                var id = $('#ProduitId').val();
                var url = id == "0" ? '@Url.Action("AjouterProduit", "Admin")' : '@Url.Action("ModifierProduit", "Admin")';

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.success) {
                            $('#produitModal').modal('hide');
                            location.reload();
                        } else {
                            alert('Erreur: ' + (response.errors ? response.errors.join("\n") : response.message));
                        }
                    },
                    error: function() {
                        alert('Une erreur est survenue lors de l\'enregistrement.');
                    }
                });
            });
        });

        function openAddModal() {
            $('#produitForm')[0].reset();
            $('#ProduitId').val("0");
            $('#modalTitle').text("Ajouter un Produit");
            // Fix for backdrop issue: move modal to body
            $('#produitModal').appendTo("body").modal('show');
        }

        function openEditModal(id) {
            $.get('@Url.Action("GetProduit", "Admin")', { id: id }, function(response) {
                if (response.success) {
                    var p = response.produit;
                    $('#ProduitId').val(p.ProduitId);
                    $('#Nom').val(p.Nom);
                    $('#CategorieId').val(p.CategorieId);
                    $('#Description').val(p.Description);
                    $('#Prix').val(p.Prix);
                    $('#StockTotal').val(p.StockTotal);
                    $('#SeuilAlerte').val(p.SeuilAlerte);
                    $('#CooperativeId').val(p.CooperativeId);
                    $('#ImageUrl').val(p.ImageUrl);
                    $('#EstDisponible').prop('checked', p.EstDisponible);
                    $('#EstEnVedette').prop('checked', p.EstEnVedette);
                    $('#EstNouveau').prop('checked', p.EstNouveau);

                    $('#modalTitle').text("Modifier le Produit");
                    // Fix for backdrop issue: move modal to body
                    $('#produitModal').appendTo("body").modal('show');
                } else {
                    alert(response.message);
                }
            });
        }

        function deleteProduct(id, nom) {
            if (confirm('Voulez-vous vraiment supprimer le produit "' + nom + '" ?')) {
                $.post('@Url.Action("SupprimerProduit", "Admin")', { id: id }, function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert('Erreur: ' + response.message);
                    }
                });
            }
        }
    </script>
}

<!-- Modal Moved Here (End of file to avoid z-index/nesting issues) -->
<div id="produitModal" class="modal fade" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Nouveau Produit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="produitForm" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="ProduitId" name="ProduitId" value="0" />
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Nom du produit</label>
                                <input type="text" id="Nom" name="Nom" class="form-input" required />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Catégorie</label>
                                <select id="CategorieId" name="CategorieId" class="form-input" required>
                                    @foreach (var cat in categories) {
                                        <option value="@cat.CategorieId">@cat.Nom</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="Description" name="Description" class="form-input" rows="3"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Prix (MAD)</label>
                                <input type="number" id="Prix" name="Prix" class="form-input" required step="0.01" />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Stock Initial</label>
                                <input type="number" id="StockTotal" name="StockTotal" class="form-input" required />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Seuil d'alerte</label>
                                <input type="number" id="SeuilAlerte" name="SeuilAlerte" class="form-input" value="5" />
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Coopérative</label>
                                <select id="CooperativeId" name="CooperativeId" class="form-input">
                                    <option value="">Sélectionner une coopérative</option>
                                    @foreach (var coop in cooperatives) {
                                        <option value="@coop.CooperativeId">@coop.Nom</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Image</label>
                                <input type="file" id="imageFile" name="imageFile" class="form-input" accept="image/*" />
                                <input type="hidden" id="ImageUrl" name="ImageUrl" />
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-4">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="EstDisponible" name="EstDisponible" value="true" checked />
                                <label class="form-check-label" for="EstDisponible">Disponible</label>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="EstEnVedette" name="EstEnVedette" value="true" />
                                <label class="form-check-label" for="EstEnVedette">Mettre en vedette</label>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="EstNouveau" name="EstNouveau" value="true" checked />
                                <label class="form-check-label" for="EstNouveau">Nouveau</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-footer mt-4">
                        <button type="button" class="btn-cancel" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" class="btn-save">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
