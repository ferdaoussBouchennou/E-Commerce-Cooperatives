@using E_Commerce_Cooperatives.Models
@{
    ViewBag.Title = "Catalogue - CoopShop";
    var produits = ViewBag.Produits as List<Produit> ?? new List<Produit>();
    var categories = ViewBag.Categories as List<Categorie> ?? new List<Categorie>();
    var cooperatives = ViewBag.Cooperatives as List<Cooperative> ?? new List<Cooperative>();
    var productCountByCategory = ViewBag.ProductCountByCategory as Dictionary<int, int> ?? new Dictionary<int, int>();
    var selectedCategorie = ViewBag.SelectedCategorie as int?;
}

@Html.Partial("_Header")

<main style="min-height: calc(100vh - 200px);">
    <div class="container py-5">
        <!-- Page Header -->
        <div class="mb-4">
            <h1 class="display-5 fw-bold mb-2">
                @if (selectedCategorie.HasValue)
                {
                    var selectedCat = categories.FirstOrDefault(c => c.CategorieId == selectedCategorie.Value);
                    @(selectedCat?.Nom ?? "Catalogue")
                }
                else
                {
                    <text>Catalogue</text>
                }
            </h1>
            <p class="text-muted">
                <span id="product-count">@produits.Count</span> produit@(produits.Count > 1 ? "s" : "") trouvé@(produits.Count > 1 ? "s" : "")
            </p>
        </div>

        <!-- Active Filters Display -->
        @if (ViewBag.SelectedCategorie != null || 
             ViewBag.MinPrice != ViewBag.GlobalMinPrice || 
             ViewBag.MaxPrice != ViewBag.GlobalMaxPrice ||
             (ViewBag.SelectedCoops != null && ((List<int>)ViewBag.SelectedCoops).Any()) ||
             ViewBag.OnlyAvailable == true ||
             ViewBag.MinRating != null)
        {
            <div class="mb-4">
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    <span class="text-muted small">Filtres actifs:</span>
                    
                    <!-- Prix Filter Badge -->
                    @if (ViewBag.MinPrice != ViewBag.GlobalMinPrice || ViewBag.MaxPrice != ViewBag.GlobalMaxPrice)
                    {
                        <span class="badge bg-light text-dark border d-inline-flex align-items-center gap-2">
                            <i class="bi bi-tag"></i>
                            Prix: @ViewBag.MinPrice - @ViewBag.MaxPrice MAD
                            <a href="@Url.Action("Index", "Catalogue", new { 
                                categorie = ViewBag.SelectedCategorie,
                                search = ViewBag.SearchTerm,
                                sort = ViewBag.CurrentSort,
                                coops = ViewBag.SelectedCoops != null ? string.Join(",", ViewBag.SelectedCoops) : null,
                                onlyAvailable = ViewBag.OnlyAvailable,
                                minRating = ViewBag.MinRating,
                                page = ViewBag.CurrentPage
                            })" class="text-decoration-none text-dark">
                                <i class="bi bi-x"></i>
                            </a>
                        </span>
                    }
                    
                    <!-- Category Filter Badge -->
                    @if (ViewBag.SelectedCategorie != null)
                    {
                        var selectedCat = categories.FirstOrDefault(c => c.CategorieId == ViewBag.SelectedCategorie);
                        <span class="badge bg-light text-dark border d-inline-flex align-items-center gap-2">
                            <i class="bi bi-folder"></i>
                            @selectedCat?.Nom
                            <a href="@Url.Action("Index", "Catalogue", new { 
                                search = ViewBag.SearchTerm,
                                sort = ViewBag.CurrentSort,
                                minPrice = ViewBag.MinPrice != ViewBag.GlobalMinPrice ? ViewBag.MinPrice : null,
                                maxPrice = ViewBag.MaxPrice != ViewBag.GlobalMaxPrice ? ViewBag.MaxPrice : null,
                                coops = ViewBag.SelectedCoops != null ? string.Join(",", ViewBag.SelectedCoops) : null,
                                onlyAvailable = ViewBag.OnlyAvailable,
                                minRating = ViewBag.MinRating,
                                page = ViewBag.CurrentPage
                            })" class="text-decoration-none text-dark">
                                <i class="bi bi-x"></i>
                            </a>
                        </span>
                    }
                    
                    <!-- Cooperatives Filter Badges -->
                    @if (ViewBag.SelectedCoops != null)
                    {
                        var selectedCoopIds = ViewBag.SelectedCoops as List<int>;
                        foreach (var coopId in selectedCoopIds)
                        {
                            var coop = cooperatives.FirstOrDefault(c => c.CooperativeId == coopId);
                            if (coop != null)
                            {
                                var otherCoops = selectedCoopIds.Where(id => id != coopId).ToList();
                                <span class="badge bg-light text-dark border d-inline-flex align-items-center gap-2">
                                    <i class="bi bi-building"></i>
                                    @coop.Nom
                                    <a href="@Url.Action("Index", "Catalogue", new { 
                                        categorie = ViewBag.SelectedCategorie,
                                        search = ViewBag.SearchTerm,
                                        sort = ViewBag.CurrentSort,
                                        minPrice = ViewBag.MinPrice != ViewBag.GlobalMinPrice ? ViewBag.MinPrice : null,
                                        maxPrice = ViewBag.MaxPrice != ViewBag.GlobalMaxPrice ? ViewBag.MaxPrice : null,
                                        coops = otherCoops.Any() ? string.Join(",", otherCoops) : null,
                                        onlyAvailable = ViewBag.OnlyAvailable,
                                        minRating = ViewBag.MinRating,
                                        page = ViewBag.CurrentPage
                                    })" class="text-decoration-none text-dark">
                                        <i class="bi bi-x"></i>
                                    </a>
                                </span>
                            }
                        }
                    }
                    
                    <!-- Rating Filter Badge -->
                    @if (ViewBag.MinRating != null)
                    {
                        <span class="badge bg-light text-dark border d-inline-flex align-items-center gap-2">
                            <i class="bi bi-star-fill text-warning"></i>
                            @ViewBag.MinRating+ étoiles
                            <a href="@Url.Action("Index", "Catalogue", new { 
                                categorie = ViewBag.SelectedCategorie,
                                search = ViewBag.SearchTerm,
                                sort = ViewBag.CurrentSort,
                                minPrice = ViewBag.MinPrice != ViewBag.GlobalMinPrice ? ViewBag.MinPrice : null,
                                maxPrice = ViewBag.MaxPrice != ViewBag.GlobalMaxPrice ? ViewBag.MaxPrice : null,
                                coops = ViewBag.SelectedCoops != null ? string.Join(",", ViewBag.SelectedCoops) : null,
                                onlyAvailable = ViewBag.OnlyAvailable,
                                page = ViewBag.CurrentPage
                            })" class="text-decoration-none text-dark">
                                <i class="bi bi-x"></i>
                            </a>
                        </span>
                    }
                    
                    <!-- Availability Filter Badge -->
                    @if (ViewBag.OnlyAvailable == true)
                    {
                        <span class="badge bg-light text-dark border d-inline-flex align-items-center gap-2">
                            <i class="bi bi-check-circle text-success"></i>
                            En stock
                            <a href="@Url.Action("Index", "Catalogue", new { 
                                categorie = ViewBag.SelectedCategorie,
                                search = ViewBag.SearchTerm,
                                sort = ViewBag.CurrentSort,
                                minPrice = ViewBag.MinPrice != ViewBag.GlobalMinPrice ? ViewBag.MinPrice : null,
                                maxPrice = ViewBag.MaxPrice != ViewBag.GlobalMaxPrice ? ViewBag.MaxPrice : null,
                                coops = ViewBag.SelectedCoops != null ? string.Join(",", ViewBag.SelectedCoops) : null,
                                minRating = ViewBag.MinRating,
                                page = ViewBag.CurrentPage
                            })" class="text-decoration-none text-dark">
                                <i class="bi bi-x"></i>
                            </a>
                        </span>
                    }
                    
                    <!-- Clear All Filters -->
                    <a href="@Url.Action("Index", "Catalogue", new { search = ViewBag.SearchTerm, sort = ViewBag.CurrentSort })" 
                       class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-x-circle me-1"></i>
                        Tout effacer
                    </a>
                </div>
            </div>
        }

        <!-- Search & Controls -->
        <div class="row mb-4">
            <div class="col-12 col-md-8 col-lg-9 mb-3 mb-md-0">
                <div class="input-group search-input-group position-relative smart-search-container">
                    <form action="@Url.Action("Index", "Catalogue")" method="get" class="d-flex w-100">
                        @if (ViewBag.SelectedCategorie != null)
                        {
                            <input type="hidden" name="categorie" value="@ViewBag.SelectedCategorie" />
                        }
                        @if (ViewBag.MinPrice != null && ViewBag.MinPrice != ViewBag.GlobalMinPrice)
                        {
                            <input type="hidden" name="minPrice" value="@ViewBag.MinPrice" />
                        }
                        @if (ViewBag.MaxPrice != null && ViewBag.MaxPrice != ViewBag.GlobalMaxPrice)
                        {
                            <input type="hidden" name="maxPrice" value="@ViewBag.MaxPrice" />
                        }
                        @if (ViewBag.SelectedCoops != null)
                        {
                             var coopsList = (ViewBag.SelectedCoops as IEnumerable<int>)?.ToList();
                             if(coopsList != null && coopsList.Any())
                             {
                                 <input type="hidden" name="coops" value="@string.Join(",", coopsList)" />
                             }
                        }
                        @if (ViewBag.OnlyAvailable == true)
                        {
                            <input type="hidden" name="onlyAvailable" value="true" />
                        }
                        @if (ViewBag.MinRating != null)
                        {
                            <input type="hidden" name="minRating" value="@ViewBag.MinRating" />
                        }
                        <button type="submit" class="input-group-text border-0 bg-transparent" style="cursor: pointer;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                            </svg>
                        </button>
                        <input type="search" name="search" id="catalogue-search-input" class="form-control border-0 bg-transparent smart-search-input" placeholder="Rechercher un produit..." value="@ViewBag.SearchTerm" autocomplete="off" />
                        @if (ViewBag.CurrentSort != null)
                        {
                            <input type="hidden" name="sort" value="@ViewBag.CurrentSort" />
                        }
                    </form>
                    <!-- Suggestions Container -->
                    <div class="search-suggestions position-absolute w-100 bg-white shadow-lg rounded-bottom start-0 overflow-hidden" style="top: 100%; z-index: 1050; display: none; border: 1px solid rgba(0,0,0,0.1); border-top: none;"></div>
                </div>
            </div>
            <div class="col-12 col-md-4 col-lg-3">
                <form action="@Url.Action("Index", "Catalogue")" method="get" id="sort-form" class="d-flex align-items-center">
                    @if (!string.IsNullOrEmpty(ViewBag.SearchTerm))
                    {
                        <input type="hidden" name="search" value="@ViewBag.SearchTerm" />
                    }
                    @if (ViewBag.SelectedCategorie != null)
                    {
                        <input type="hidden" name="categorie" value="@ViewBag.SelectedCategorie" />
                    }
                    @if (ViewBag.MinPrice != null && ViewBag.MinPrice != ViewBag.GlobalMinPrice)
                    {
                        <input type="hidden" name="minPrice" value="@ViewBag.MinPrice" />
                    }
                    @if (ViewBag.MaxPrice != null && ViewBag.MaxPrice != ViewBag.GlobalMaxPrice)
                    {
                        <input type="hidden" name="maxPrice" value="@ViewBag.MaxPrice" />
                    }
                    @if (ViewBag.SelectedCoops != null)
                    {
                         var coopsList = (ViewBag.SelectedCoops as IEnumerable<int>)?.ToList();
                         if(coopsList != null && coopsList.Any())
                         {
                             <input type="hidden" name="coops" value="@string.Join(",", coopsList)" />
                         }
                    }
                    @if (ViewBag.OnlyAvailable == true)
                    {
                        <input type="hidden" name="onlyAvailable" value="true" />
                    }
                    @if (ViewBag.MinRating != null)
                    {
                        <input type="hidden" name="minRating" value="@ViewBag.MinRating" />
                    }

                    <label for="sort" class="me-2 text-nowrap">Trier par :</label>
                    <select name="sort" id="sort" class="form-select form-select-sm border-terracotta" onchange="this.form.submit()">
                        <option value="popular" @(ViewBag.CurrentSort == "popular" ? "selected" : "")>Popularité</option>
                        <option value="newest" @(ViewBag.CurrentSort == "newest" ? "selected" : "")>Nouveautés</option>
                        <option value="price-asc" @(ViewBag.CurrentSort == "price-asc" ? "selected" : "")>Prix croissant</option>
                        <option value="price-desc" @(ViewBag.CurrentSort == "price-desc" ? "selected" : "")>Prix décroissant</option>
                        <option value="rating" @(ViewBag.CurrentSort == "rating" ? "selected" : "")>Note moyenne</option>
                    </select>
                </form>
            </div>
        </div>

        <!-- Mobile Filter Button -->
        <div class="mb-4 d-lg-none">
            <button class="btn btn-outline-secondary w-100" type="button" data-bs-toggle="offcanvas" data-bs-target="#filterOffcanvas">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-funnel me-2" viewBox="0 0 16 16">
                    <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2zm1 .5v1.308l4.372 4.858A.5.5 0 0 1 7 8.5v5.306l2-.666V8.5a.5.5 0 0 1 .128-.334L13.5 3.308V2h-11z"/>
                </svg>
                Filtres
            </button>
        </div>

        <div class="row">
            <!-- Desktop Sidebar Filters -->
            <aside class="col-lg-3 d-none d-lg-block">
                <form id="filter-form" action="@Url.Action("Index", "Catalogue")" method="get" class="bg-white rounded-3 p-4 shadow-sm sticky-top" style="top: 120px; z-index: 900;">
                    <h3 class="h5 fw-bold mb-4">Filtres</h3>
                    
                    <!-- Hidden inputs to preserve other states -->
                    @if (!string.IsNullOrEmpty(ViewBag.SearchTerm))
                    {
                        <input type="hidden" name="search" value="@ViewBag.SearchTerm" />
                    }
                    @if (ViewBag.CurrentSort != null)
                    {
                        <input type="hidden" name="sort" value="@ViewBag.CurrentSort" />
                    }

                    <!-- Price Range -->
                    <div class="mb-4">
                        <h4 class="h6 fw-semibold mb-3">Prix (MAD)</h4>
                        <div class="px-2">
                             @{
                                 var globalMax = ViewBag.GlobalMaxPrice ?? 1500m;
                                 var globalMin = ViewBag.GlobalMinPrice ?? 0m;
                                 var currentMin = ViewBag.MinPrice ?? globalMin;
                                 var currentMax = ViewBag.MaxPrice ?? globalMax;
                             }
                            <label for="price-range-min" class="form-label small">Minimum</label>
                            <input type="range" class="form-range" id="price-range-min" name="minPrice" min="@globalMin" max="@globalMax" step="10" value="@currentMin" onchange="this.form.submit()" />
                            
                            <label for="price-range-max" class="form-label small mt-3">Maximum</label>
                            <input type="range" class="form-range" id="price-range-max" name="maxPrice" min="@globalMin" max="@globalMax" step="10" value="@currentMax" onchange="this.form.submit()" />
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span class="small text-muted" id="price-min">@currentMin MAD</span>
                            <span class="small text-muted" id="price-max">@currentMax MAD</span>
                        </div>
                    </div>

                    <!-- Categories -->
                    <div class="mb-4">
                        <h4 class="h6 fw-semibold mb-3">Catégories</h4>
                        <div class="filter-categories">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="categorie" value="" id="cat-all" @(ViewBag.SelectedCategorie == null ? "checked" : "") onchange="this.form.submit()" />
                                <label class="form-check-label cursor-pointer" for="cat-all">Toutes les catégories</label>
                            </div>
                            @foreach (var category in categories)
                            {
                                var count = productCountByCategory.ContainsKey(category.CategorieId) ? productCountByCategory[category.CategorieId] : 0;
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="categorie" value="@category.CategorieId" id="cat-@category.CategorieId" 
                                           @(selectedCategorie == category.CategorieId ? "checked" : "") onchange="this.form.submit()" />
                                    <label class="form-check-label w-100 d-flex justify-content-between cursor-pointer" for="cat-@category.CategorieId">
                                        <span class="small">@category.Nom</span>
                                        <span class="small text-muted">(@count)</span>
                                    </label>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Cooperatives -->
                    <div class="mb-4">
                        <h4 class="h6 fw-semibold mb-3">Coopératives</h4>
                        <div class="filter-cooperatives" style="max-height: 200px; overflow-y: auto;">
                            <input type="hidden" name="coops" id="coops-hidden" value="@(ViewBag.SelectedCoops != null ? string.Join(",", ViewBag.SelectedCoops) : "")" />
                            @foreach (var cooperative in cooperatives)
                            {
                                var selectedCoops = (ViewBag.SelectedCoops as IEnumerable<int>)?.ToList();
                                var isChecked = selectedCoops != null && selectedCoops.Contains(cooperative.CooperativeId);
                                <div class="form-check mb-2">
                                    <input class="form-check-input filter-cooperative-checkbox" type="checkbox" value="@cooperative.CooperativeId" id="coop-@cooperative.CooperativeId" @(isChecked ? "checked" : "") />
                                    <label class="form-check-label cursor-pointer" for="coop-@cooperative.CooperativeId">
                                        <span class="small">@cooperative.Nom</span>
                                    </label>
                                </div>
                            }
                        </div>
                    </div>
                    
                    <!-- Customer Ratings -->
                    <div class="mb-4">
                        <h4 class="h6 fw-semibold mb-3">Notes clients</h4>
                        <div class="filter-ratings">
                            @{ var currentRating = ViewBag.MinRating as int?; }
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="minRating" value="5" id="rating-5" @(currentRating == 5 ? "checked" : "") onchange="this.form.submit()" />
                                <label class="form-check-label cursor-pointer" for="rating-5">
                                    <span class="text-warning"><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i></span>
                                    <span class="small text-muted ms-1">5 étoiles</span>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="minRating" value="4" id="rating-4" @(currentRating == 4 ? "checked" : "") onchange="this.form.submit()" />
                                <label class="form-check-label cursor-pointer" for="rating-4">
                                    <span class="text-warning"><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star"></i></span>
                                    <span class="small text-muted ms-1">4+ étoiles</span>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="minRating" value="3" id="rating-3" @(currentRating == 3 ? "checked" : "") onchange="this.form.submit()" />
                                <label class="form-check-label cursor-pointer" for="rating-3">
                                    <span class="text-warning"><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star"></i><i class="bi bi-star"></i></span>
                                    <span class="small text-muted ms-1">3+ étoiles</span>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="minRating" value="2" id="rating-2" @(currentRating == 2 ? "checked" : "") onchange="this.form.submit()" />
                                <label class="form-check-label cursor-pointer" for="rating-2">
                                    <span class="text-warning"><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star"></i><i class="bi bi-star"></i><i class="bi bi-star"></i></span>
                                    <span class="small text-muted ms-1">2+ étoiles</span>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="minRating" value="1" id="rating-1" @(currentRating == 1 ? "checked" : "") onchange="this.form.submit()" />
                                <label class="form-check-label cursor-pointer" for="rating-1">
                                    <span class="text-warning"><i class="bi bi-star-fill"></i><i class="bi bi-star"></i><i class="bi bi-star"></i><i class="bi bi-star"></i><i class="bi bi-star"></i></span>
                                    <span class="small text-muted ms-1">1+ étoile</span>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="minRating" value="" id="rating-all" @(!currentRating.HasValue ? "checked" : "") onchange="this.form.submit()" />
                                <label class="form-check-label cursor-pointer small" for="rating-all">
                                    Toutes les notes
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Clear Filters -->
                    <a href="@Url.Action("Index", "Catalogue")" class="btn btn-outline-secondary w-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle me-2" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                        </svg>
                        Effacer les filtres
                    </a>
                </form>
            </aside>

            <!-- Mobile Offcanvas Filters -->
            <div class="offcanvas offcanvas-start" tabindex="-1" id="filterOffcanvas">
                <div class="offcanvas-header border-bottom">
                    <h5 class="offcanvas-title fw-bold">Filtres</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
                </div>
                <div class="offcanvas-body">
                    <!-- Price Range -->
                    <div class="mb-4">
                        <h4 class="h6 fw-semibold mb-3">Prix (MAD)</h4>
                        <div class="px-2">
                             @{
                                 var globalMaxM = ViewBag.GlobalMaxPrice ?? 1500m;
                                 var globalMinM = ViewBag.GlobalMinPrice ?? 0m;
                                 var currentMinM = ViewBag.MinPrice ?? globalMinM;
                                 var currentMaxM = ViewBag.MaxPrice ?? globalMaxM;
                             }
                            <label for="price-range-min-mobile" class="form-label small">Minimum</label>
                            <input type="range" class="form-range" id="price-range-min-mobile" min="@globalMinM" max="@globalMaxM" step="10" value="@currentMinM" />
                            
                            <label for="price-range-max-mobile" class="form-label small mt-3">Maximum</label>
                            <input type="range" class="form-range" id="price-range-max-mobile" min="@globalMinM" max="@globalMaxM" step="10" value="@currentMaxM" />
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span class="small text-muted" id="price-min-mobile">@currentMinM MAD</span>
                            <span class="small text-muted" id="price-max-mobile">@currentMaxM MAD</span>
                        </div>
                    </div>

                    <!-- Categories -->
                    <div class="mb-4">
                        <h4 class="h6 fw-semibold mb-3">Catégories</h4>
                        <div class="filter-categories-mobile">
                            <div class="form-check mb-2">
                                <input class="form-check-input filter-category-mobile" type="radio" name="categorieMobile" value="" id="cat-mobile-all" @(ViewBag.SelectedCategorie == null ? "checked" : "") />
                                <label class="form-check-label cursor-pointer" for="cat-mobile-all">
                                    <span class="small">Toutes les catégories</span>
                                </label>
                            </div>
                            @foreach (var category in categories)
                            {
                                var count = productCountByCategory.ContainsKey(category.CategorieId) ? productCountByCategory[category.CategorieId] : 0;
                                <div class="form-check mb-2">
                                    <input class="form-check-input filter-category-mobile" type="radio" name="categorieMobile" value="@category.CategorieId" id="cat-mobile-@category.CategorieId" 
                                           @(selectedCategorie == category.CategorieId ? "checked" : "") />
                                    <label class="form-check-label w-100 d-flex justify-content-between cursor-pointer" for="cat-mobile-@category.CategorieId">
                                        <span class="small">@category.Nom</span>
                                        <span class="small text-muted">(@count)</span>
                                    </label>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Cooperatives -->
                    <div class="mb-4">
                        <h4 class="h6 fw-semibold mb-3">Coopératives</h4>
                        <div class="filter-cooperatives-mobile" style="max-height: 250px; overflow-y: auto;">
                            @foreach (var cooperative in cooperatives)
                            {
                                var selectedCoops = (ViewBag.SelectedCoops as IEnumerable<int>)?.ToList();
                                var isChecked = selectedCoops != null && selectedCoops.Contains(cooperative.CooperativeId);
                                <div class="form-check mb-2">
                                    <input class="form-check-input filter-cooperative-mobile" type="checkbox" value="@cooperative.CooperativeId" id="coop-mobile-@cooperative.CooperativeId" @(isChecked ? "checked" : "") />
                                    <label class="form-check-label cursor-pointer" for="coop-mobile-@cooperative.CooperativeId">
                                        <span class="small">@cooperative.Nom</span>
                                    </label>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Customer Ratings -->
                    <div class="mb-4">
                        <h4 class="h6 fw-semibold mb-3">Notes clients</h4>
                        <div class="filter-ratings-mobile">
                            @{ var currentRatingM = ViewBag.MinRating as int?; }
                            <div class="form-check mb-2">
                                <input class="form-check-input filter-rating-mobile" type="radio" name="minRatingMobile" value="5" id="rating-mobile-5" @(currentRatingM == 5 ? "checked" : "") />
                                <label class="form-check-label cursor-pointer" for="rating-mobile-5">
                                    <span class="text-warning"><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i></span>
                                    <span class="small text-muted ms-1">5 étoiles</span>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input filter-rating-mobile" type="radio" name="minRatingMobile" value="4" id="rating-mobile-4" @(currentRatingM == 4 ? "checked" : "") />
                                <label class="form-check-label cursor-pointer" for="rating-mobile-4">
                                    <span class="text-warning"><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star"></i></span>
                                    <span class="small text-muted ms-1">4+ étoiles</span>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input filter-rating-mobile" type="radio" name="minRatingMobile" value="3" id="rating-mobile-3" @(currentRatingM == 3 ? "checked" : "") />
                                <label class="form-check-label cursor-pointer" for="rating-mobile-3">
                                    <span class="text-warning"><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star"></i><i class="bi bi-star"></i></span>
                                    <span class="small text-muted ms-1">3+ étoiles</span>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input filter-rating-mobile" type="radio" name="minRatingMobile" value="2" id="rating-mobile-2" @(currentRatingM == 2 ? "checked" : "") />
                                <label class="form-check-label cursor-pointer" for="rating-mobile-2">
                                    <span class="text-warning"><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star"></i><i class="bi bi-star"></i><i class="bi bi-star"></i></span>
                                    <span class="small text-muted ms-1">2+ étoiles</span>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input filter-rating-mobile" type="radio" name="minRatingMobile" value="1" id="rating-mobile-1" @(currentRatingM == 1 ? "checked" : "") />
                                <label class="form-check-label cursor-pointer" for="rating-mobile-1">
                                    <span class="text-warning"><i class="bi bi-star-fill"></i><i class="bi bi-star"></i><i class="bi bi-star"></i><i class="bi bi-star"></i><i class="bi bi-star"></i></span>
                                    <span class="small text-muted ms-1">1+ étoile</span>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input filter-rating-mobile" type="radio" name="minRatingMobile" value="" id="rating-mobile-all" @(!currentRatingM.HasValue ? "checked" : "") />
                                <label class="form-check-label cursor-pointer small" for="rating-mobile-all">
                                    Toutes les notes
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Availability -->
                    <div class="mb-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="only-available-mobile" @(ViewBag.OnlyAvailable == true ? "checked" : "") />
                            <label class="form-check-label cursor-pointer" for="only-available-mobile">
                                <span class="small fw-medium">En stock uniquement</span>
                            </label>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="d-grid gap-2 mt-4">
                        <button type="button" class="btn btn-primary text-white" id="apply-mobile-filters">
                            <i class="bi bi-check-circle me-2"></i>
                            Appliquer les filtres
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="clear-filters-mobile">
                            <i class="bi bi-x-circle me-2"></i>
                            Effacer les filtres
                        </button>
                    </div>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="col-lg-9">
                <div id="products-container">
                    @if (produits.Any())
                    {
                        <div class="row g-4" id="products-grid">
                            @foreach (var produit in produits)
                            {
                                <div class="col-sm-6 col-xl-4 product-item" 
                                     data-produit-id="@produit.ProduitId"
                                     data-categorie-id="@(produit.CategorieId ?? 0)"
                                     data-cooperative-id="@(produit.CooperativeId ?? 0)"
                                     data-prix="@produit.Prix"
                                     data-note="@produit.NoteMoyenne"
                                     data-nombre-avis="@produit.NombreAvis"
                                     data-est-nouveau="@(produit.EstNouveau ? "true" : "false")"
                                     data-est-disponible="@(produit.EstDisponible ? "true" : "false")"
                                     data-stock="@produit.StockTotal"
                                     data-nom="@produit.Nom.ToLower()"
                                     data-description="@(produit.Description ?? "").ToLower()">
                                    @Html.Partial("_ProductCard", produit)
                                </div>
                            }
                        </div>

                        <!-- Pagination -->
                        if (ViewBag.TotalPages != null && (int)ViewBag.TotalPages > 1)
                        {
                            var currentPage = (int)ViewBag.CurrentPage;
                            var totalPages = (int)ViewBag.TotalPages;

                            <nav aria-label="Page navigation" class="mt-5">
                                <ul class="pagination justify-content-center">
                                    @{
                                        var routeValues = new System.Web.Routing.RouteValueDictionary();
                                        if (!string.IsNullOrEmpty(ViewBag.SearchTerm)) { routeValues["search"] = ViewBag.SearchTerm; }
                                        if (!string.IsNullOrEmpty(ViewBag.CurrentSort)) { routeValues["sort"] = ViewBag.CurrentSort; }
                                        if (ViewBag.SelectedCategorie != null) { routeValues["categorie"] = ViewBag.SelectedCategorie; }
                                        if (ViewBag.MinPrice != null && ViewBag.MinPrice != ViewBag.GlobalMinPrice) { routeValues["minPrice"] = ViewBag.MinPrice; }
                                        if (ViewBag.MaxPrice != null && ViewBag.MaxPrice != ViewBag.GlobalMaxPrice) { routeValues["maxPrice"] = ViewBag.MaxPrice; }
                                        if (ViewBag.SelectedCoops != null) {
                                             var coopsList = ViewBag.SelectedCoops as List<int>;
                                             if(coopsList != null && coopsList.Any()) 
                                             { 
                                                 routeValues["coops"] = string.Join(",", coopsList); 
                                             }
                                        }
                                        if (ViewBag.OnlyAvailable == true) { routeValues["onlyAvailable"] = true; }
                                        if (ViewBag.MinRating != null) { routeValues["minRating"] = ViewBag.MinRating; }
                                    }

                                    @if (ViewBag.CurrentPage > 1)
                                    {
                                        routeValues["page"] = ViewBag.CurrentPage - 1;
                                        <li class="page-item">
                                            <a class="page-link text-terracotta" href="@Url.Action("Index", "Catalogue", routeValues)" aria-label="Previous">
                                                <span aria-hidden="true">&laquo;</span>
                                            </a>
                                        </li>
                                    }

                                    @for (int i = 1; i <= ViewBag.TotalPages; i++)
                                    {
                                        routeValues["page"] = i;
                                        <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                                            <a class="page-link @(i == ViewBag.CurrentPage ? "bg-terracotta border-terracotta text-white" : "text-terracotta")" href="@Url.Action("Index", "Catalogue", routeValues)">@i</a>
                                        </li>
                                    }

                                    @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                                    {
                                        routeValues["page"] = ViewBag.CurrentPage + 1;
                                        <li class="page-item">
                                            <a class="page-link text-terracotta" href="@Url.Action("Index", "Catalogue", routeValues)" aria-label="Next">
                                                <span aria-hidden="true">&raquo;</span>
                                            </a>
                                        </li>
                                    }
                                </ul>
                            </nav>
                        }
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <div class="mb-4">
                                <i class="bi bi-search" style="font-size: 4rem; color: #ccc;"></i>
                            </div>
                            <h3 class="h5 text-muted mb-3">Aucun produit trouvé</h3>
                            <p class="text-muted mb-4">Aucun produit ne correspond à vos critères de recherche</p>
                            <a href="@Url.Action("Index", "Catalogue")" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-counterclockwise me-2"></i>
                                Réinitialiser les filtres
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</main>

@Html.Partial("_Footer")

@section scripts {
    <script src="~/Scripts/catalogue.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var searchTerm = '@Html.Raw(HttpUtility.JavaScriptStringEncode(ViewBag.SearchTerm as string))';
            if (searchTerm && searchTerm.length > 0) {
                try {
                    var regex = new RegExp('(' + searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\                            <label for="price-range-max-mobile" class="form-label small mt-3">Maximum</label>
                            <input type="range" class="form-range" id="price-range-max-mobile" min="@globalMin') + ')', 'gi');
                    var titles = document.querySelectorAll('.product-title');
                    titles.forEach(function(title) {
                        var text = title.textContent;
                        if (text.toLowerCase().includes(searchTerm.toLowerCase())) {
                            title.innerHTML = text.replace(regex, '<span class="bg-warning bg-opacity-25 text-dark fw-bold px-1 rounded">$1</span>');
                        }
                    });
                } catch (e) {
                    console.error("Highlighting error", e);
                }
            }
        });
    </script>
}

